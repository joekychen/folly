<!DOCTYPE html>
<html><head><title>joekychen/folly » folly › test › ConcurrentSkipListBenchmark.cpp

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ConcurrentSkipListBenchmark.cpp</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2012 Facebook, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="cm"> * you may not use this file except in compliance with the License.</span>
<span class="cm"> * You may obtain a copy of the License at</span>
<span class="cm"> *</span>
<span class="cm"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="cm"> *</span>
<span class="cm"> * Unless required by applicable law or agreed to in writing, software</span>
<span class="cm"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="cm"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="cm"> * See the License for the specific language governing permissions and</span>
<span class="cm"> * limitations under the License.</span>
<span class="cm"> */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>@author: Xin Liu <a href="&#x6D;&#97;&#105;&#x6C;&#116;&#111;:&#x78;&#108;&#105;&#x75;x&#64;&#x66;&#x62;&#46;&#99;&#111;&#109;">&#x78;&#108;&#105;&#x75;x&#64;&#x66;&#x62;&#46;&#99;&#111;&#109;</a></p></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;map&gt;</span>
<span class="cp">#include &lt;set&gt;</span>
<span class="cp">#include &lt;thread&gt;</span>

<span class="cp">#include &lt;boost/shared_ptr.hpp&gt;</span>

<span class="cp">#include &lt;gflags/gflags.h&gt;</span>
<span class="cp">#include &lt;glog/logging.h&gt;</span>
<span class="cp">#include &quot;folly/Benchmark.h&quot;</span>
<span class="cp">#include &quot;folly/ConcurrentSkipList.h&quot;</span>
<span class="cp">#include &quot;folly/Hash.h&quot;</span>
<span class="cp">#include &quot;folly/RWSpinLock.h&quot;</span>


<span class="n">DEFINE_int32</span><span class="p">(</span><span class="n">num_threads</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s">&quot;num concurrent threads to test&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>In some case, we may want to test worker threads operating on multiple
lists. For example in search, not all threads are visiting the same posting
list, but for the ones with some popular terms, they do get multiple
visitors at the same time.</p></td><td class="code"><div class="highlight"><pre><span class="n">DEFINE_int32</span><span class="p">(</span><span class="n">num_sets</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;num of set to operate on&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">kInitHeadHeight</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">kMaxValue</span> <span class="o">=</span> <span class="mh">0x1000000</span><span class="p">;</span>

<span class="k">namespace</span> <span class="p">{</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">folly</span><span class="p">;</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="n">ValueType</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">ConcurrentSkipList</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">&gt;</span> <span class="n">SkipListType</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">SkipListType</span><span class="o">::</span><span class="n">Accessor</span> <span class="n">SkipListAccessor</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">&gt;</span> <span class="n">SetType</span><span class="p">;</span>

<span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">&gt;</span> <span class="n">gData</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">initData</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">gData</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">kMaxValue</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">kMaxValue</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">random_shuffle</span><span class="p">(</span><span class="n">gData</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">gData</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>single thread benchmarks</p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="n">BM_IterateOverSet</span><span class="p">(</span><span class="kt">int</span> <span class="n">iters</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">SetType</span> <span class="n">a_set</span><span class="p">;</span>

  <span class="n">BENCHMARK_SUSPEND</span> <span class="p">{</span>
    <span class="n">CHECK_GT</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">a_set</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">gData</span><span class="p">[</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">kMaxValue</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">int64_t</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">a_set</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">iter</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iter</span> <span class="o">==</span> <span class="n">a_set</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">a_set</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">BENCHMARK_SUSPEND</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>VLOG(20) &lt;&lt; "sum = " &lt;&lt; sum;</p></td><td class="code"><div class="highlight"><pre>  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BM_IterateSkipList</span><span class="p">(</span><span class="kt">int</span> <span class="n">iters</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="n">CHECK_GT</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">skipList</span> <span class="o">=</span> <span class="n">SkipListType</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">kInitHeadHeight</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">skipList</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">kMaxValue</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">int64_t</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>

  <span class="k">auto</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">skipList</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">iter</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iter</span> <span class="o">==</span> <span class="n">skipList</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">skipList</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">BENCHMARK_SUSPEND</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>VLOG(20) &lt;&lt; "sum = " &lt;&lt; sum;</p></td><td class="code"><div class="highlight"><pre>  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BM_SetMerge</span><span class="p">(</span><span class="kt">int</span> <span class="n">iters</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="n">SetType</span> <span class="n">a_set</span><span class="p">;</span>
  <span class="n">SetType</span> <span class="n">b_set</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">a_set</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">kMaxValue</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">b_set</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">kMaxValue</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>

  <span class="n">int64_t</span> <span class="n">mergedSum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">FOR_EACH</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">a_set</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">b_set</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">)</span> <span class="o">!=</span> <span class="n">b_set</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="n">mergedSum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">BENCHMARK_SUSPEND</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>VLOG(20) &lt;&lt; mergedSum;</p></td><td class="code"><div class="highlight"><pre>  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BM_CSLMergeLookup</span><span class="p">(</span><span class="kt">int</span> <span class="n">iters</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">skipList</span> <span class="o">=</span> <span class="n">SkipListType</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">kInitHeadHeight</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">skipList2</span> <span class="o">=</span> <span class="n">SkipListType</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">kInitHeadHeight</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">skipList</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">kMaxValue</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">skipList2</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">kMaxValue</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">int64_t</span> <span class="n">mergedSum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>

  <span class="n">SkipListType</span><span class="o">::</span><span class="n">Skipper</span> <span class="n">skipper</span><span class="p">(</span><span class="n">skipList2</span><span class="p">);</span>
  <span class="n">FOR_EACH</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">skipList</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">skipper</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">))</span> <span class="n">mergedSum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">BENCHMARK_SUSPEND</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>VLOG(20) &lt;&lt; mergedSum;</p></td><td class="code"><div class="highlight"><pre>  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>merge by two skippers</p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="n">BM_CSLMergeIntersection</span><span class="p">(</span><span class="kt">int</span> <span class="n">iters</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">skipList</span> <span class="o">=</span> <span class="n">SkipListType</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">kInitHeadHeight</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">skipList2</span> <span class="o">=</span> <span class="n">SkipListType</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">kInitHeadHeight</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">skipList</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">kMaxValue</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">skipList2</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">kMaxValue</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>

  <span class="n">SkipListType</span><span class="o">::</span><span class="n">Skipper</span> <span class="n">s1</span><span class="p">(</span><span class="n">skipList</span><span class="p">);</span>
  <span class="n">SkipListType</span><span class="o">::</span><span class="n">Skipper</span> <span class="n">s2</span><span class="p">(</span><span class="n">skipList2</span><span class="p">);</span>

  <span class="n">int64_t</span> <span class="n">mergedSum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">s1</span><span class="p">.</span><span class="n">good</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">s2</span><span class="p">.</span><span class="n">good</span><span class="p">())</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">s1</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">s2</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v1</span> <span class="o">&lt;</span> <span class="n">v2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">s1</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">v2</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v1</span> <span class="o">&gt;</span> <span class="n">v2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">s2</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">v1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">mergedSum</span> <span class="o">+=</span> <span class="n">v1</span><span class="p">;</span>
      <span class="o">++</span><span class="n">s1</span><span class="p">;</span>
      <span class="o">++</span><span class="n">s2</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">BENCHMARK_SUSPEND</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>VLOG(20) &lt;&lt; mergedSum;</p></td><td class="code"><div class="highlight"><pre>  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BM_SetContainsNotFound</span><span class="p">(</span><span class="kt">int</span> <span class="n">iters</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="n">SetType</span> <span class="n">aset</span><span class="p">;</span>
  <span class="n">CHECK_LT</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">kMaxValue</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">aset</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">int64_t</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">aset</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">==</span> <span class="n">aset</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">BENCHMARK_SUSPEND</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>VLOG(20) &lt;&lt; sum;</p></td><td class="code"><div class="highlight"><pre>  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BM_SetContainsFound</span><span class="p">(</span><span class="kt">int</span> <span class="n">iters</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="n">SetType</span> <span class="n">aset</span><span class="p">;</span>
  <span class="n">CHECK_LT</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">kMaxValue</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">aset</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">values</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">size</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">int64_t</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">aset</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">==</span> <span class="n">aset</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
  <span class="p">}</span>

  <span class="n">BENCHMARK_SUSPEND</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>VLOG(20) &lt;&lt; sum;</p></td><td class="code"><div class="highlight"><pre>  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BM_CSLContainsFound</span><span class="p">(</span><span class="kt">int</span> <span class="n">iters</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">skipList</span> <span class="o">=</span> <span class="n">SkipListType</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">kInitHeadHeight</span><span class="p">);</span>
  <span class="n">CHECK_LT</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">kMaxValue</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">skipList</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">values</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">size</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">int64_t</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="n">skipList</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="n">BENCHMARK_SUSPEND</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>VLOG(20) &lt;&lt; sum;</p></td><td class="code"><div class="highlight"><pre>  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BM_CSLContainsNotFound</span><span class="p">(</span><span class="kt">int</span> <span class="n">iters</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">skipList</span> <span class="o">=</span> <span class="n">SkipListType</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">kInitHeadHeight</span><span class="p">);</span>
  <span class="n">CHECK_LT</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">kMaxValue</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">skipList</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">int64_t</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="n">skipList</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">BENCHMARK_SUSPEND</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>VLOG(20) &lt;&lt; sum;</p></td><td class="code"><div class="highlight"><pre>  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BM_AddSet</span><span class="p">(</span><span class="kt">int</span> <span class="n">iters</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="n">SetType</span> <span class="n">aset</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">aset</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">gData</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">+</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">aset</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">gData</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BM_AddSkipList</span><span class="p">(</span><span class="kt">int</span> <span class="n">iters</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">skipList</span> <span class="o">=</span> <span class="n">SkipListType</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">kInitHeadHeight</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">skipList</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">gData</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">+</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">skipList</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">gData</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">BENCHMARK</span><span class="p">(</span><span class="n">Accessor</span><span class="p">,</span> <span class="n">iters</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">skiplist</span> <span class="o">=</span> <span class="n">SkipListType</span><span class="o">::</span><span class="n">createInstance</span><span class="p">(</span><span class="n">kInitHeadHeight</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">sl</span> <span class="o">=</span> <span class="n">skiplist</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>

  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SkipListAccessor</span> <span class="n">accessor</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>a benchmark to estimate the
low bound of doing a ref counting for an Accessor</p></td><td class="code"><div class="highlight"><pre><span class="n">BENCHMARK</span><span class="p">(</span><span class="n">accessorBasicRefcounting</span><span class="p">,</span> <span class="n">iters</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="k">auto</span><span class="o">*</span> <span class="n">value</span> <span class="o">=</span> <span class="k">new</span> <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">int32_t</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="k">auto</span><span class="o">*</span> <span class="n">dirty</span> <span class="o">=</span> <span class="k">new</span> <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">int32_t</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">folly</span><span class="o">::</span><span class="n">MicroSpinLock</span> <span class="n">l</span><span class="p">;</span>
  <span class="n">l</span><span class="p">.</span><span class="n">init</span><span class="p">();</span>

  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">value</span><span class="o">-&gt;</span><span class="n">fetch_add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dirty</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">folly</span><span class="o">::</span><span class="n">MSLGuard</span> <span class="n">g</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">value</span><span class="o">-&gt;</span><span class="n">fetch_sub</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">BENCHMARK_SUSPEND</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="n">dirty</span><span class="p">;</span>
    <span class="k">delete</span> <span class="n">value</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Data For testing contention benchmark</p></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConcurrentAccessData</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">ConcurrentAccessData</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="o">:</span>
    <span class="n">skipList_</span><span class="p">(</span><span class="n">SkipListType</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span>
    <span class="n">sets_</span><span class="p">(</span><span class="n">FLAGS_num_sets</span><span class="p">),</span> <span class="n">locks_</span><span class="p">(</span><span class="n">FLAGS_num_sets</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sets_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
      <span class="n">skipList_</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FLAGS_num_sets</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">locks_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RWSpinLock</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">sets_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sets_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>memory usage</p></td><td class="code"><div class="highlight"><pre>    <span class="n">int64_t</span> <span class="n">setMemorySize</span> <span class="o">=</span> <span class="n">sets_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span><span class="p">()</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sets_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">begin</span><span class="p">().</span><span class="n">_M_node</span><span class="p">);</span>
    <span class="n">int64_t</span> <span class="n">cslMemorySize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">skipList_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">skipList_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cslMemorySize</span> <span class="o">+=</span> <span class="n">it</span><span class="p">.</span><span class="n">nodeSize</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;size=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sets_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span><span class="p">()</span>
      <span class="o">&lt;&lt;</span> <span class="s">&quot;; std::set memory size=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">setMemorySize</span>
      <span class="o">&lt;&lt;</span> <span class="s">&quot;; csl memory size=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">cslMemorySize</span><span class="p">;</span>

    <span class="n">readValues_</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="n">deleteValues_</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="n">writeValues_</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">readValues_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
      <span class="n">deleteValues_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>half new values and half already in the list</p></td><td class="code"><div class="highlight"><pre>      <span class="n">writeValues_</span><span class="p">.</span><span class="n">push_back</span><span class="p">((</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">random_shuffle</span><span class="p">(</span><span class="n">readValues_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">readValues_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
    <span class="n">std</span><span class="o">::</span><span class="n">random_shuffle</span><span class="p">(</span><span class="n">deleteValues_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">deleteValues_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
    <span class="n">std</span><span class="o">::</span><span class="n">random_shuffle</span><span class="p">(</span><span class="n">writeValues_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">writeValues_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="o">~</span><span class="n">ConcurrentAccessData</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">FOR_EACH</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">locks_</span><span class="p">)</span> <span class="k">delete</span> <span class="o">*</span><span class="n">lock</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kr">inline</span> <span class="kt">bool</span> <span class="n">skipListFind</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ValueType</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">skipList_</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kr">inline</span> <span class="kt">void</span> <span class="n">skipListInsert</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ValueType</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">skipList_</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kr">inline</span> <span class="kt">void</span> <span class="n">skipListErase</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ValueType</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">skipList_</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kr">inline</span> <span class="kt">bool</span> <span class="n">setFind</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ValueType</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">RWSpinLock</span><span class="o">::</span><span class="n">ReadHolder</span> <span class="n">g</span><span class="p">(</span><span class="n">locks_</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
    <span class="k">return</span> <span class="n">sets_</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">find</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="n">sets_</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">end</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kr">inline</span> <span class="kt">void</span> <span class="n">setInsert</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ValueType</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">RWSpinLock</span><span class="o">::</span><span class="n">WriteHolder</span> <span class="n">g</span><span class="p">(</span><span class="n">locks_</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
    <span class="n">sets_</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kr">inline</span> <span class="kt">void</span> <span class="n">setErase</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ValueType</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">RWSpinLock</span><span class="o">::</span><span class="n">WriteHolder</span> <span class="n">g</span><span class="p">(</span><span class="n">locks_</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
    <span class="n">sets_</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">erase</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">runSkipList</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iters</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sum</span> <span class="o">+=</span> <span class="n">accessSkipList</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>VLOG(20) &lt;&lt; sum;</p></td><td class="code"><div class="highlight"><pre>  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">runSet</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iters</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iters</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sum</span> <span class="o">+=</span> <span class="n">accessSet</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>VLOG(20) &lt;&lt; sum;</p></td><td class="code"><div class="highlight"><pre>  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">accessSkipList</span><span class="p">(</span><span class="n">int64_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">readValues_</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">%</span> <span class="n">readValues_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">uint32_t</span> <span class="n">h</span> <span class="o">=</span> <span class="n">folly</span><span class="o">::</span><span class="n">hash</span><span class="o">::</span><span class="n">twang_32from64</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">id</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">h</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="mi">7</span><span class="o">:</span>   <span class="c1">// write</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0x31</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 1/4 chance to delete</span>
          <span class="n">skipListErase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">deleteValues_</span><span class="p">[</span><span class="n">t</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">skipListInsert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">writeValues_</span><span class="p">[</span><span class="n">t</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">skipListFind</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">readValues_</span><span class="p">[</span><span class="n">t</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">accessSet</span><span class="p">(</span><span class="n">int64_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">readValues_</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">%</span> <span class="n">readValues_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">uint32_t</span> <span class="n">h</span> <span class="o">=</span> <span class="n">folly</span><span class="o">::</span><span class="n">hash</span><span class="o">::</span><span class="n">twang_32from64</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">id</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">%</span> <span class="n">FLAGS_num_sets</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">h</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// 1/8 chance to write</span>
      <span class="k">case</span> <span class="mi">7</span><span class="o">:</span>   <span class="c1">// write</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0x31</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 1/32 chance to delete</span>
          <span class="n">setErase</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">deleteValues_</span><span class="p">[</span><span class="n">t</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">setInsert</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">writeValues_</span><span class="p">[</span><span class="n">t</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">setFind</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">readValues_</span><span class="p">[</span><span class="n">t</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">SkipListType</span><span class="o">::</span><span class="n">Accessor</span> <span class="n">skipList_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">SetType</span><span class="o">&gt;</span> <span class="n">sets_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RWSpinLock</span><span class="o">*&gt;</span> <span class="n">locks_</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">&gt;</span> <span class="n">readValues_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">&gt;</span> <span class="n">writeValues_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">&gt;</span> <span class="n">deleteValues_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ConcurrentAccessData</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">g_data</span><span class="p">;</span>

<span class="k">static</span> <span class="n">ConcurrentAccessData</span> <span class="o">*</span><span class="n">mayInitTestData</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">g_data</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">==</span> <span class="n">g_data</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ConcurrentAccessData</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="k">new</span> <span class="n">ConcurrentAccessData</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
    <span class="n">g_data</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">ptr</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BM_ContentionCSL</span><span class="p">(</span><span class="kt">int</span> <span class="n">iters</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mayInitTestData</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">;</span>
  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FLAGS_num_threads</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">threads</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span>
          <span class="o">&amp;</span><span class="n">ConcurrentAccessData</span><span class="o">::</span><span class="n">runSkipList</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">iters</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="n">FOR_EACH</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">threads</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">).</span><span class="n">join</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BM_ContentionStdSet</span><span class="p">(</span><span class="kt">int</span> <span class="n">iters</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BenchmarkSuspender</span> <span class="n">susp</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mayInitTestData</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">;</span>
  <span class="n">susp</span><span class="p">.</span><span class="n">dismiss</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FLAGS_num_threads</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">threads</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span>
          <span class="o">&amp;</span><span class="n">ConcurrentAccessData</span><span class="o">::</span><span class="n">runSet</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">iters</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="n">FOR_EACH</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">threads</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">).</span><span class="n">join</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">susp</span><span class="p">.</span><span class="n">rehire</span><span class="p">();</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Single-thread benchmarking</p></td><td class="code"><div class="highlight"><pre><span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>

<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_IterateOverSet</span><span class="p">,</span>  <span class="mi">1000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_IterateSkipList</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_IterateOverSet</span><span class="p">,</span>  <span class="mi">1000000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_IterateSkipList</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>find with keys in the set</p></td><td class="code"><div class="highlight"><pre><span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_SetContainsFound</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_CSLContainsFound</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_SetContainsFound</span><span class="p">,</span> <span class="mi">100000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_CSLContainsFound</span><span class="p">,</span> <span class="mi">100000</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_SetContainsFound</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_CSLContainsFound</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_SetContainsFound</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_CSLContainsFound</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>find with keys not in the set</p></td><td class="code"><div class="highlight"><pre><span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_SetContainsNotFound</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_CSLContainsNotFound</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_SetContainsNotFound</span><span class="p">,</span> <span class="mi">100000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_CSLContainsNotFound</span><span class="p">,</span> <span class="mi">100000</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_SetContainsNotFound</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_CSLContainsNotFound</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>


<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_AddSet</span><span class="p">,</span>      <span class="mi">1000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_AddSkipList</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>

<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_AddSet</span><span class="p">,</span>      <span class="mi">65536</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_AddSkipList</span><span class="p">,</span> <span class="mi">65536</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>

<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_AddSet</span><span class="p">,</span>      <span class="mi">1000000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_AddSkipList</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>

<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_SetMerge</span><span class="p">,</span>             <span class="mi">1000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_CSLMergeIntersection</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_CSLMergeLookup</span><span class="p">,</span>       <span class="mi">1000</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>

<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_SetMerge</span><span class="p">,</span>             <span class="mi">65536</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_CSLMergeIntersection</span><span class="p">,</span> <span class="mi">65536</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_CSLMergeLookup</span><span class="p">,</span>       <span class="mi">65536</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>

<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_SetMerge</span><span class="p">,</span>             <span class="mi">1000000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_CSLMergeIntersection</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_CSLMergeLookup</span><span class="p">,</span>       <span class="mi">1000000</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>multithreaded benchmarking</p></td><td class="code"><div class="highlight"><pre><span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_ContentionStdSet</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_ContentionCSL</span><span class="p">,</span>    <span class="mi">1024</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>

<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_ContentionStdSet</span><span class="p">,</span> <span class="mi">65536</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_ContentionCSL</span><span class="p">,</span>    <span class="mi">65536</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>

<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_ContentionStdSet</span><span class="p">,</span> <span class="mi">1048576</span><span class="p">);</span>
<span class="n">BENCHMARK_PARAM</span><span class="p">(</span><span class="n">BM_ContentionCSL</span><span class="p">,</span>    <span class="mi">1048576</span><span class="p">);</span>
<span class="n">BENCHMARK_DRAW_LINE</span><span class="p">();</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">google</span><span class="o">::</span><span class="n">InitGoogleLogging</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">google</span><span class="o">::</span><span class="n">ParseCommandLineFlags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

  <span class="n">initData</span><span class="p">();</span>
  <span class="n">runBenchmarks</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*</span>
<span class="c">Benchmark on Intel(R) Xeon(R) CPU X5650 @2.67GHz</span>

<span class="c">==============================================================================</span>
<span class="c">1 thread Benchmark                     Iters   Total t    t/iter iter/sec</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> +37.0% BM_Accessor                    100000  1.958 ms  19.58 ns  48.71 M</span>
<span class="c">*       BM_AccessorBasicRefcounting    100000  1.429 ms  14.29 ns  66.74 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> + 603% BM_IterateOverSet/1000         100000  1.589 ms  15.89 ns  60.02 M</span>
<span class="c">*       BM_IterateSkipList/1000        100000    226 us   2.26 ns    422 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> + 107% BM_IterateOverSet/976.6k       100000  8.324 ms  83.24 ns  11.46 M</span>
<span class="c">*       BM_IterateSkipList/976.6k      100000  4.016 ms  40.16 ns  23.75 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c">*       BM_SetContainsFound/1000       100000  7.082 ms  70.82 ns  13.47 M</span>
<span class="c"> +39.9% BM_CSLContainsFound/1000       100000  9.908 ms  99.08 ns  9.625 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c">*       BM_SetContainsFound/97.66k     100000   23.8 ms    238 ns  4.006 M</span>
<span class="c"> +5.97% BM_CSLContainsFound/97.66k     100000  25.23 ms  252.3 ns  3.781 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> +33.6% BM_SetContainsFound/976.6k     100000   64.3 ms    643 ns  1.483 M</span>
<span class="c">*       BM_CSLContainsFound/976.6k     100000  48.13 ms  481.3 ns  1.981 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> +30.3% BM_SetContainsFound/9.537M     100000  115.1 ms  1.151 us  848.6 k</span>
<span class="c">*       BM_CSLContainsFound/9.537M     100000  88.33 ms  883.3 ns   1.08 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c">*       BM_SetContainsNotFound/1000    100000  2.081 ms  20.81 ns  45.83 M</span>
<span class="c"> +76.2% BM_CSLContainsNotFound/1000    100000  3.667 ms  36.67 ns  26.01 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c">*       BM_SetContainsNotFound/97.66k  100000  6.049 ms  60.49 ns  15.77 M</span>
<span class="c"> +32.7% BM_CSLContainsNotFound/97.66k  100000  8.025 ms  80.25 ns  11.88 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c">*       BM_SetContainsNotFound/976.6k  100000  7.464 ms  74.64 ns  12.78 M</span>
<span class="c"> +12.8% BM_CSLContainsNotFound/976.6k  100000  8.417 ms  84.17 ns  11.33 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c">*       BM_AddSet/1000                 100000  29.26 ms  292.6 ns  3.259 M</span>
<span class="c"> +70.0% BM_AddSkipList/1000            100000  49.75 ms  497.5 ns  1.917 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c">*       BM_AddSet/64k                  100000  38.73 ms  387.3 ns  2.462 M</span>
<span class="c"> +55.7% BM_AddSkipList/64k             100000   60.3 ms    603 ns  1.581 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c">*       BM_AddSet/976.6k               100000  75.71 ms  757.1 ns   1.26 M</span>
<span class="c"> +33.6% BM_AddSkipList/976.6k          100000  101.2 ms  1.012 us  965.3 k</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> + 716% BM_SetMerge/1000               100000  6.872 ms  68.72 ns  13.88 M</span>
<span class="c">*       BM_CSLMergeIntersection/1000   100000    842 us   8.42 ns  113.3 M</span>
<span class="c"> + 268% BM_CSLMergeLookup/1000         100000    3.1 ms     31 ns  30.76 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> +36.3% BM_SetMerge/64k                100000  14.03 ms  140.3 ns  6.798 M</span>
<span class="c"> +39.4% BM_CSLMergeIntersection/64k    100000  14.35 ms  143.5 ns  6.645 M</span>
<span class="c">*       BM_CSLMergeLookup/64k          100000  10.29 ms  102.9 ns  9.266 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> +10.3% BM_SetMerge/976.6k             100000  46.24 ms  462.4 ns  2.062 M</span>
<span class="c"> +25.1% BM_CSLMergeIntersection/976.6k 100000  52.47 ms  524.7 ns  1.818 M</span>
<span class="c">*       BM_CSLMergeLookup/976.6k       100000  41.94 ms  419.3 ns  2.274 M</span>
<span class="c">------------------------------------------------------------------------------</span>


<span class="c">==============================================================================</span>
<span class="c">Contention benchmark 7/8 find, 3/32 insert, 1/32 erase</span>

<span class="c"> 4 threads Benchmark                   Iters   Total t    t/iter iter/sec</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> + 269% BM_ContentionStdSet/1k         100000  75.66 ms  756.6 ns   1.26 M</span>
<span class="c">*       BM_ContentionCSL/1k            100000  20.47 ms  204.7 ns  4.658 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> + 228% BM_ContentionStdSet/64k        100000  105.6 ms  1.056 us  924.9 k</span>
<span class="c">*       BM_ContentionCSL/64k           100000  32.18 ms  321.8 ns  2.963 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> + 224% BM_ContentionStdSet/1M         100000  117.4 ms  1.174 us  832.2 k</span>
<span class="c">*       BM_ContentionCSL/1M            100000  36.18 ms  361.8 ns  2.636 M</span>
<span class="c">------------------------------------------------------------------------------</span>


<span class="c">12 threads Benchmark                   Iters   Total t    t/iter iter/sec</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> + 697% BM_ContentionStdSet/1k         100000  455.3 ms  4.553 us  214.5 k</span>
<span class="c">*       BM_ContentionCSL/1k            100000  57.12 ms  571.2 ns   1.67 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> +1257% BM_ContentionStdSet/64k        100000  654.9 ms  6.549 us  149.1 k</span>
<span class="c">*       BM_ContentionCSL/64k           100000  48.24 ms  482.4 ns  1.977 M</span>
<span class="c">------------------------------------------------------------------------------</span>
<span class="c"> +1262% BM_ContentionStdSet/1M         100000  657.3 ms  6.573 us  148.6 k</span>
<span class="c">*       BM_ContentionCSL/1M            100000  48.25 ms  482.5 ns  1.977 M</span>
<span class="c">------------------------------------------------------------------------------</span>

<span class="c">*/</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/folly",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
