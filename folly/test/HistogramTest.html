<!DOCTYPE html>
<html><head><title>joekychen/folly » folly › test › HistogramTest.cpp

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>HistogramTest.cpp</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2012 Facebook, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="cm"> * you may not use this file except in compliance with the License.</span>
<span class="cm"> * You may obtain a copy of the License at</span>
<span class="cm"> *</span>
<span class="cm"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="cm"> *</span>
<span class="cm"> * Unless required by applicable law or agreed to in writing, software</span>
<span class="cm"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="cm"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="cm"> * See the License for the specific language governing permissions and</span>
<span class="cm"> * limitations under the License.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;folly/Histogram.h&quot;</span>

<span class="cp">#include &lt;gflags/gflags.h&gt;</span>
<span class="cp">#include &lt;gtest/gtest.h&gt;</span>

<span class="k">using</span> <span class="n">folly</span><span class="o">::</span><span class="n">Histogram</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Insert 100 evenly distributed values into a histogram with 100 buckets</p></td><td class="code"><div class="highlight"><pre><span class="n">TEST</span><span class="p">(</span><span class="n">Histogram</span><span class="p">,</span> <span class="n">Test100</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Histogram</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;</span> <span class="n">h</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">h</span><span class="p">.</span><span class="n">addValue</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>100 buckets, plus 1 for below min, and 1 for above max</p></td><td class="code"><div class="highlight"><pre>  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">getNumBuckets</span><span class="p">(),</span> <span class="mi">102</span><span class="p">);</span>

  <span class="kt">double</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">pct</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Floating point arithmetic isn't 100% accurate, and if we just divide
(n / 100) the value should be exactly on a bucket boundary.  Add espilon
to ensure we fall in the upper bucket.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">double</span> <span class="n">lowPct</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
      <span class="kt">double</span> <span class="n">highPct</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bucketIdx</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileBucketIdx</span><span class="p">(</span><span class="n">pct</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">,</span>
                                                        <span class="o">&amp;</span><span class="n">lowPct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">highPct</span><span class="p">);</span>
      <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bucketIdx</span><span class="p">);</span>
      <span class="n">EXPECT_FLOAT_EQ</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">lowPct</span><span class="p">);</span>
      <span class="n">EXPECT_FLOAT_EQ</span><span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">highPct</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Also test n - epsilon, to test falling in the lower bucket.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">double</span> <span class="n">lowPct</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
      <span class="kt">double</span> <span class="n">highPct</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bucketIdx</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileBucketIdx</span><span class="p">(</span><span class="n">pct</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">,</span>
                                                        <span class="o">&amp;</span><span class="n">lowPct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">highPct</span><span class="p">);</span>
      <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">bucketIdx</span><span class="p">);</span>
      <span class="n">EXPECT_FLOAT_EQ</span><span class="p">((</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">lowPct</span><span class="p">);</span>
      <span class="n">EXPECT_FLOAT_EQ</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">highPct</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Check getPercentileEstimate()</p></td><td class="code"><div class="highlight"><pre>    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileEstimate</span><span class="p">(</span><span class="n">pct</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Test calling getPercentileBucketIdx() and getPercentileEstimate() on an
empty histogram</p></td><td class="code"><div class="highlight"><pre><span class="n">TEST</span><span class="p">(</span><span class="n">Histogram</span><span class="p">,</span> <span class="n">TestEmpty</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Histogram</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;</span> <span class="n">h</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">pct</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">;</span>

    <span class="kt">double</span> <span class="n">lowPct</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">highPct</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bucketIdx</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileBucketIdx</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lowPct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">highPct</span><span class="p">);</span>
    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bucketIdx</span><span class="p">);</span>
    <span class="n">EXPECT_FLOAT_EQ</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">lowPct</span><span class="p">);</span>
    <span class="n">EXPECT_FLOAT_EQ</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">highPct</span><span class="p">);</span>

    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileEstimate</span><span class="p">(</span><span class="n">pct</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Test calling getPercentileBucketIdx() and getPercentileEstimate() on a
histogram with just a single value.</p></td><td class="code"><div class="highlight"><pre><span class="n">TEST</span><span class="p">(</span><span class="n">Histogram</span><span class="p">,</span> <span class="n">Test1</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Histogram</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;</span> <span class="n">h</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="n">h</span><span class="p">.</span><span class="n">addValue</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">pct</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">;</span>

    <span class="kt">double</span> <span class="n">lowPct</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">highPct</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bucketIdx</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileBucketIdx</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lowPct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">highPct</span><span class="p">);</span>
    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">43</span><span class="p">,</span> <span class="n">bucketIdx</span><span class="p">);</span>
    <span class="n">EXPECT_FLOAT_EQ</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">lowPct</span><span class="p">);</span>
    <span class="n">EXPECT_FLOAT_EQ</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">highPct</span><span class="p">);</span>

    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileEstimate</span><span class="p">(</span><span class="n">pct</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Test adding enough numbers to make the sum value overflow in the
"below min" bucket</p></td><td class="code"><div class="highlight"><pre><span class="n">TEST</span><span class="p">(</span><span class="n">Histogram</span><span class="p">,</span> <span class="n">TestOverflowMin</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Histogram</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;</span> <span class="n">h</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">h</span><span class="p">.</span><span class="n">addValue</span><span class="p">(</span><span class="o">-</span><span class="mh">0x0fffffffffffffff</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Compute a percentile estimate.  We only added values to the "below min"
bucket, so this should check that bucket.  We're mainly verifying that the
code doesn't crash here when the bucket average is larger than the max
value that is supposed to be in the bucket.</p></td><td class="code"><div class="highlight"><pre>  <span class="n">int64_t</span> <span class="n">estimate</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileEstimate</span><span class="p">(</span><span class="mf">0.05</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>The code will return the smallest possible value when it detects an
overflow beyond the minimum value.</p></td><td class="code"><div class="highlight"><pre>  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;::</span><span class="n">min</span><span class="p">(),</span> <span class="n">estimate</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Test adding enough numbers to make the sum value overflow in the
"above max" bucket</p></td><td class="code"><div class="highlight"><pre><span class="n">TEST</span><span class="p">(</span><span class="n">Histogram</span><span class="p">,</span> <span class="n">TestOverflowMax</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Histogram</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;</span> <span class="n">h</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">h</span><span class="p">.</span><span class="n">addValue</span><span class="p">(</span><span class="mh">0x0fffffffffffffff</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>The code will return the maximum possible value when it detects an
overflow beyond the max value.</p></td><td class="code"><div class="highlight"><pre>  <span class="n">int64_t</span> <span class="n">estimate</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileEstimate</span><span class="p">(</span><span class="mf">0.95</span><span class="p">);</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">(),</span> <span class="n">estimate</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Test adding enough numbers to make the sum value overflow in one of the
normal buckets</p></td><td class="code"><div class="highlight"><pre><span class="n">TEST</span><span class="p">(</span><span class="n">Histogram</span><span class="p">,</span> <span class="n">TestOverflowBucket</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Histogram</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;</span> <span class="n">h</span><span class="p">(</span><span class="mh">0x0100000000000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000000000000000</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">h</span><span class="p">.</span><span class="n">addValue</span><span class="p">(</span><span class="mh">0x0fffffffffffffff</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>The histogram code should return the bucket midpoint
when it detects overflow.</p></td><td class="code"><div class="highlight"><pre>  <span class="n">int64_t</span> <span class="n">estimate</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileEstimate</span><span class="p">(</span><span class="mf">0.95</span><span class="p">);</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mh">0x0f80000000000000</span><span class="p">,</span> <span class="n">estimate</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">Histogram</span><span class="p">,</span> <span class="n">TestDouble</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Insert 100 evenly spaced values into a histogram</p></td><td class="code"><div class="highlight"><pre>  <span class="n">Histogram</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">h</span><span class="p">(</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">5000.0</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">double</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">h</span><span class="p">.</span><span class="n">addValue</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getNumBuckets</span><span class="p">());</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mf">2500.0</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileEstimate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">));</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mf">4500.0</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileEstimate</span><span class="p">(</span><span class="mf">0.9</span><span class="p">));</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Test where the bucket width is not an even multiple of the histogram range</p></td><td class="code"><div class="highlight"><pre><span class="n">TEST</span><span class="p">(</span><span class="n">Histogram</span><span class="p">,</span> <span class="n">TestDoubleInexactWidth</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Histogram</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">h</span><span class="p">(</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">4970.0</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">double</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">h</span><span class="p">.</span><span class="n">addValue</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getNumBuckets</span><span class="p">());</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mf">2500.0</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileEstimate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">));</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mf">4500.0</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileEstimate</span><span class="p">(</span><span class="mf">0.9</span><span class="p">));</span>

  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getBucketByIndex</span><span class="p">(</span><span class="mi">51</span><span class="p">).</span><span class="n">count</span><span class="p">);</span>
  <span class="n">h</span><span class="p">.</span><span class="n">addValue</span><span class="p">(</span><span class="mi">4990</span><span class="p">);</span>
  <span class="n">h</span><span class="p">.</span><span class="n">addValue</span><span class="p">(</span><span class="mi">5100</span><span class="p">);</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getBucketByIndex</span><span class="p">(</span><span class="mi">51</span><span class="p">).</span><span class="n">count</span><span class="p">);</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mf">2600.0</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileEstimate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">));</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Test where the bucket width is larger than the histogram range
(There isn't really much point to defining a histogram this way,
but we want to ensure that it still works just in case.)</p></td><td class="code"><div class="highlight"><pre><span class="n">TEST</span><span class="p">(</span><span class="n">Histogram</span><span class="p">,</span> <span class="n">TestDoubleWidthTooBig</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Histogram</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">h</span><span class="p">(</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">);</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getNumBuckets</span><span class="p">());</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">double</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">h</span><span class="p">.</span><span class="n">addValue</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getBucketByIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">count</span><span class="p">);</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getBucketByIndex</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">count</span><span class="p">);</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getBucketByIndex</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">count</span><span class="p">);</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileEstimate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">));</span>

  <span class="n">h</span><span class="p">.</span><span class="n">addValue</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">);</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getBucketByIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">count</span><span class="p">);</span>
  <span class="n">h</span><span class="p">.</span><span class="n">addValue</span><span class="p">(</span><span class="mf">7.5</span><span class="p">);</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getBucketByIndex</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">count</span><span class="p">);</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">getPercentileEstimate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">));</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/folly",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
