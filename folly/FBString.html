<!DOCTYPE html>
<html><head><title>joekychen/folly » folly › FBString.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>FBString.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2012 Facebook, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="cm"> * you may not use this file except in compliance with the License.</span>
<span class="cm"> * You may obtain a copy of the License at</span>
<span class="cm"> *</span>
<span class="cm"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="cm"> *</span>
<span class="cm"> * Unless required by applicable law or agreed to in writing, software</span>
<span class="cm"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="cm"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="cm"> * See the License for the specific language governing permissions and</span>
<span class="cm"> * limitations under the License.</span>
<span class="cm"> */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>@author: Andrei Alexandrescu (aalexandre)
String type.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef FOLLY_BASE_FBSTRING_H_</span>
<span class="cp">#define FOLLY_BASE_FBSTRING_H_</span>

<span class="cm">/**</span>
<span class="cm">   fbstring&#39;s behavior can be configured via two macro definitions, as</span>
<span class="cm">   follows. Normally, fbstring does not write a &#39;\0&#39; at the end of</span>
<span class="cm">   each string whenever it changes the underlying characters. Instead,</span>
<span class="cm">   it lazily writes the &#39;\0&#39; whenever either c_str() or data()</span>
<span class="cm">   called.</span>

<span class="cm">   This is standard-compliant behavior and may save costs in some</span>
<span class="cm">   circumstances. However, it may be surprising to some client code</span>
<span class="cm">   because c_str() and data() are const member functions (fbstring</span>
<span class="cm">   uses the &quot;mutable&quot; storage class for its own state).</span>

<span class="cm">   In order to appease client code that expects fbstring to be</span>
<span class="cm">   zero-terminated at all times, if the preprocessor symbol</span>
<span class="cm">   FBSTRING_CONSERVATIVE is defined, fbstring does exactly that,</span>
<span class="cm">   i.e. it goes the extra mile to guarantee a &#39;\0&#39; is always planted</span>
<span class="cm">   at the end of its data.</span>

<span class="cm">   On the contrary, if the desire is to debug faulty client code that</span>
<span class="cm">   unduly assumes the &#39;\0&#39; is present, fbstring plants a &#39;^&#39; (i.e.,</span>
<span class="cm">   emphatically NOT a zero) at the end of each string if</span>
<span class="cm">   FBSTRING_PERVERSE is defined. (Calling c_str() or data() still</span>
<span class="cm">   writes the &#39;\0&#39;, of course.)</span>

<span class="cm">   The preprocessor symbols FBSTRING_PERVERSE and</span>
<span class="cm">   FBSTRING_CONSERVATIVE cannot be defined simultaneously. This is</span>
<span class="cm">   enforced during preprocessing.</span>
<span class="cm">*/</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><h1>define FBSTRING_PERVERSE</h1>

<h1>define FBSTRING_CONSERVATIVE</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef FBSTRING_PERVERSE</span>
<span class="cp">#ifdef FBSTRING_CONSERVATIVE</span>
<span class="cp">#error Cannot define both FBSTRING_PERVERSE and FBSTRING_CONSERVATIVE.</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>This file appears in two locations: inside fbcode and in the
libstdc++ source code (when embedding fbstring as std::string).
To aid in this schizophrenic use, two macros are defined in
c++config.h:
  <em>LIBSTDCXX</em>FBSTRING - Set inside libstdc++.  This is useful to
     gate use inside fbcode v. libstdc++</p></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;bits/c++config.h&gt;</span>

<span class="cp">#ifdef _LIBSTDCXX_FBSTRING</span>

<span class="cp">#pragma GCC system_header</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Handle the cases where the fbcode version (folly/Malloc.h) is included
either before or after this inclusion.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef FOLLY_MALLOC_H_</span>
<span class="cp">#undef FOLLY_MALLOC_H_</span>
<span class="cp">#include &quot;basic_fbstring_malloc.h&quot;</span>
<span class="cp">#else</span>
<span class="cp">#include &quot;basic_fbstring_malloc.h&quot;</span>
<span class="cp">#undef FOLLY_MALLOC_H_</span>
<span class="cp">#endif</span>

<span class="cp">#else </span><span class="c1">// !_LIBSTDCXX_FBSTRING</span>

<span class="cp">#include &lt;string&gt;</span>
<span class="cp">#include &lt;cstring&gt;</span>
<span class="cp">#include &lt;cassert&gt;</span>

<span class="cp">#include &quot;folly/Traits.h&quot;</span>
<span class="cp">#include &quot;folly/Malloc.h&quot;</span>
<span class="cp">#include &quot;folly/Hash.h&quot;</span>

<span class="cp">#endif</span>

<span class="cp">#include &lt;atomic&gt;</span>
<span class="cp">#include &lt;limits&gt;</span>
<span class="cp">#include &lt;type_traits&gt;</span>

<span class="cp">#ifdef _LIBSTDCXX_FBSTRING</span>
<span class="n">namespace</span> <span class="n">std</span> <span class="nf">_GLIBCXX_VISIBILITY</span><span class="p">(</span><span class="k">default</span><span class="p">)</span> <span class="p">{</span>
<span class="n">_GLIBCXX_BEGIN_NAMESPACE_VERSION</span>
<span class="cp">#else</span>
<span class="n">namespace</span> <span class="n">folly</span> <span class="p">{</span>
<span class="cp">#endif</span>

<span class="n">namespace</span> <span class="n">fbstring_detail</span> <span class="p">{</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">InIt</span><span class="p">,</span> <span class="n">class</span> <span class="n">OutIt</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">OutIt</span> <span class="n">copy_n</span><span class="p">(</span><span class="n">InIt</span> <span class="n">b</span><span class="p">,</span>
             <span class="kr">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">iterator_traits</span><span class="o">&lt;</span><span class="n">InIt</span><span class="o">&gt;::</span><span class="n">difference_type</span> <span class="n">n</span><span class="p">,</span>
             <span class="n">OutIt</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">n</span><span class="p">,</span> <span class="o">++</span><span class="n">b</span><span class="p">,</span> <span class="o">++</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">((</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;*</span><span class="n">d</span> <span class="o">!=</span> <span class="o">&amp;*</span><span class="n">b</span><span class="p">);</span>
    <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">Pod</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">pod_fill</span><span class="p">(</span><span class="n">Pod</span><span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">Pod</span><span class="o">*</span> <span class="n">e</span><span class="p">,</span> <span class="n">T</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="p">);</span>
  <span class="cm">/*static*/</span> <span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">b</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="k">const</span> <span class="n">ee</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="p">((</span><span class="n">e</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7u</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">b</span> <span class="o">!=</span> <span class="n">ee</span><span class="p">;</span> <span class="n">b</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
      <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
      <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
      <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
      <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
      <span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
      <span class="n">b</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
      <span class="n">b</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Leftovers</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(;</span> <span class="n">b</span> <span class="o">!=</span> <span class="n">e</span><span class="p">;</span> <span class="o">++</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Lightly structured memcpy, simplifies copying PODs and introduces</span>
<span class="cm"> * some asserts</span>
<span class="cm"> */</span>
<span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">Pod</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">Pod</span><span class="o">*</span> <span class="n">pod_copy</span><span class="p">(</span><span class="k">const</span> <span class="n">Pod</span><span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="k">const</span> <span class="n">Pod</span><span class="o">*</span> <span class="n">e</span><span class="p">,</span> <span class="n">Pod</span><span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">e</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">d</span> <span class="o">&gt;=</span> <span class="n">e</span> <span class="o">||</span> <span class="n">d</span> <span class="o">+</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="p">);</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">s</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">s</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">d</span> <span class="o">+</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Lightly structured memmove, simplifies copying PODs and introduces</span>
<span class="cm"> * some asserts</span>
<span class="cm"> */</span>
<span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">Pod</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">pod_move</span><span class="p">(</span><span class="k">const</span> <span class="n">Pod</span><span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="k">const</span> <span class="n">Pod</span><span class="o">*</span> <span class="n">e</span><span class="p">,</span> <span class="n">Pod</span><span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">e</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="p">);</span>
  <span class="n">memmove</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">));</span>
<span class="p">}</span>

<span class="p">}</span> <span class="c1">// namespace fbstring_detail</span>

<span class="cm">/**</span>
<span class="cm"> * Defines a special acquisition method for constructing fbstring</span>
<span class="cm"> * objects. AcquireMallocatedString means that the user passes a</span>
<span class="cm"> * pointer to a malloc-allocated string that the fbstring object will</span>
<span class="cm"> * take into custody.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">class</span> <span class="n">AcquireMallocatedString</span> <span class="p">{};</span>

<span class="cm">/*</span>
<span class="cm"> * fbstring_core_model is a mock-up type that defines all required</span>
<span class="cm"> * signatures of a fbstring core. The fbstring class itself uses such</span>
<span class="cm"> * a core object to implement all of the numerous member functions</span>
<span class="cm"> * required by the standard.</span>
<span class="cm"> *</span>
<span class="cm"> * If you want to define a new core, copy the definition below and</span>
<span class="cm"> * implement the primitives. Then plug the core into basic_fbstring as</span>
<span class="cm"> * a template argument.</span>

<span class="cm">template &lt;class Char&gt;</span>
<span class="cm">class fbstring_core_model {</span>
<span class="cm">public:</span>
<span class="cm">  fbstring_core_model();</span>
<span class="cm">  fbstring_core_model(const fbstring_core_model &amp;);</span>
<span class="cm">  ~fbstring_core_model();</span>

<span class="cm">//DIVIDER</span>
<span class="cm">  const Char * data() const;</span>

<span class="cm">//DIVIDER</span>
<span class="cm">  Char * mutable_data();</span>

<span class="cm">//DIVIDER</span>
<span class="cm">  const Char * c_str() const;</span>

<span class="cm">//DIVIDER</span>
<span class="cm">  void shrink(size_t delta);</span>

<span class="cm">//DIVIDER</span>
<span class="cm">  void expand_noinit(size_t delta);</span>

<span class="cm">//DIVIDER</span>
<span class="cm">  void push_back(Char c);</span>

<span class="cm">//DIVIDER</span>
<span class="cm">  size_t size() const;</span>

<span class="cm">//DIVIDER</span>
<span class="cm">  size_t capacity() const;</span>

<span class="cm">//DIVIDER</span>
<span class="cm">  bool isShared() const;</span>

<span class="cm">//DIVIDER</span>
<span class="cm">  void reserve(size_t minCapacity);</span>
<span class="cm">private:</span>

<span class="cm">//DIVIDER</span>
<span class="cm">  fbstring_core_model&amp; operator=(const fbstring_core_model &amp;);</span>
<span class="cm">};</span>
<span class="cm">*/</span>

<span class="cm">/**</span>
<span class="cm"> * This is the core of the string. The code should work on 32- and</span>
<span class="cm"> * 64-bit architectures and with any Char size. Porting to big endian</span>
<span class="cm"> * architectures would require some changes.</span>
<span class="cm"> *</span>
<span class="cm"> * The storage is selected as follows (assuming we store one-byte</span>
<span class="cm"> * characters on a 64-bit machine): (a) &quot;small&quot; strings between 0 and</span>
<span class="cm"> * 23 chars are stored in-situ without allocation (the rightmost byte</span>
<span class="cm"> * stores the size); (b) &quot;medium&quot; strings from 24 through 254 chars</span>
<span class="cm"> * are stored in malloc-allocated memory that is copied eagerly; (c)</span>
<span class="cm"> * &quot;large&quot; strings of 255 chars and above are stored in a similar</span>
<span class="cm"> * structure as medium arrays, except that the string is</span>
<span class="cm"> * reference-counted and copied lazily. the reference count is</span>
<span class="cm"> * allocated right before the character array.</span>
<span class="cm"> *</span>
<span class="cm"> * The discriminator between these three strategies sits in the two</span>
<span class="cm"> * most significant bits of the rightmost char of the storage. If</span>
<span class="cm"> * neither is set, then the string is small (and its length sits in</span>
<span class="cm"> * the lower-order bits of that rightmost character). If the MSb is</span>
<span class="cm"> * set, the string is medium width. If the second MSb is set, then the</span>
<span class="cm"> * string is large.</span>
<span class="cm"> */</span>
<span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="n">class</span> <span class="n">fbstring_core</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">fbstring_core</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Returns a pointer to string's buffer (currently only contiguous
strings are supported). The pointer is guaranteed to be valid
until the next call to a non-const member function.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span> <span class="o">=</span> <span class="n">maxSmallSize</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Much like data(), except the string is prepared to support
character-level changes. This call is a signal for
e.g. reference-counted implementation to fork the data. The
pointer is guaranteed to be valid until the next call to a
non-const member function.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">writeTerminator</span><span class="p">();</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isSmall</span> <span class="o">&amp;&amp;</span> <span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">fbstring_core</span><span class="p">(</span><span class="k">const</span> <span class="n">fbstring_core</span> <span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhs</span> <span class="o">!=</span> <span class="n">this</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Returns a pointer to string's buffer and guarantees that a
readable '\0' lies right after the buffer. The pointer is
guaranteed to be valid until the next call to a non-const member
function.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isSmall</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">MediumLarge</span><span class="p">,</span> <span class="n">data_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">MediumLarge</span><span class="p">,</span> <span class="n">size_</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">));</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">MediumLarge</span><span class="p">,</span> <span class="n">capacity_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">));</span>
      <span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">smallSize</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span><span class="p">;</span>
        <span class="n">writeTerminator</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Shrinks the string by delta characters. Asserts that delta &lt;=
size().</p></td><td class="code"><div class="highlight"><pre>        <span class="n">ml_</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">ml_</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isSmall</span> <span class="o">&amp;&amp;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isLarge</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Expands the string by delta characters (i.e. after this call
size() will report the old size() plus delta) but without
initializing the expanded region. The caller is expected to fill
the expanded area appropriately.</p></td><td class="code"><div class="highlight"><pre>      <span class="n">ml_</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">ml_</span><span class="p">;</span>
      <span class="n">RefCounted</span><span class="o">::</span><span class="n">incrementRefs</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">);</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isLarge</span> <span class="o">&amp;&amp;</span> <span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Expands the string by one character and sets the last character
to c.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">auto</span> <span class="k">const</span> <span class="n">allocSize</span> <span class="o">=</span>
           <span class="n">goodMallocSize</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">.</span><span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">));</span>
      <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">checkedMalloc</span><span class="p">(</span><span class="n">allocSize</span><span class="p">));</span>
      <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Returns the string's size.</p></td><td class="code"><div class="highlight"><pre>                                <span class="n">rhs</span><span class="p">.</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">.</span><span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Returns the string's capacity, i.e. maximum size that the string
can grow to without reallocation. Note that for reference counted
strings that's technically a lie - even assigning characters
within the existing size would cause a reallocation.</p></td><td class="code"><div class="highlight"><pre>      <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">;</span>
      <span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span> <span class="o">=</span> <span class="p">(</span><span class="n">allocSize</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">isMedium</span><span class="p">;</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isMedium</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">data</span><span class="p">(),</span> <span class="n">rhs</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">size</span><span class="p">()</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">fbstring_core</span><span class="p">(</span><span class="n">fbstring_core</span><span class="o">&amp;&amp;</span> <span class="n">goner</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">goner</span><span class="p">.</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isSmall</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Returns true if the data underlying the string is actually shared
across multiple strings (in a refcounted fashion).</p></td><td class="code"><div class="highlight"><pre>      <span class="n">new</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="n">fbstring_core</span><span class="p">(</span><span class="n">goner</span><span class="p">.</span><span class="n">small_</span><span class="p">,</span> <span class="n">goner</span><span class="p">.</span><span class="n">smallSize</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Makes sure that at least minCapacity characters are available for
the string without reallocation. For reference-counted strings,
it should fork the data even if minCapacity &lt; size().</p></td><td class="code"><div class="highlight"><pre>      <span class="n">ml_</span> <span class="o">=</span> <span class="n">goner</span><span class="p">.</span><span class="n">ml_</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Do not implement</p></td><td class="code"><div class="highlight"><pre>      <span class="n">goner</span><span class="p">.</span><span class="n">setSmallSize</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">fbstring_core</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="k">const</span> <span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Only initialize the tag, will set the MSBs (i.e. the small
string size) to zero too</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">maxSmallSize</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>or: setSmallSize(0);</p></td><td class="code"><div class="highlight"><pre>      <span class="cm">/*static_*/</span><span class="n">assert</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="o">*</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">));</span>
      <span class="cm">/*static_*/</span><span class="n">assert</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="o">*</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Simplest case first: small strings are bitblitted</p></td><td class="code"><div class="highlight"><pre>      <span class="cm">/*static_*/</span><span class="n">assert</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Just write the whole thing, don't look at details. In
particular we need to copy capacity anyway because we want
to set the size (don't forget that the last character,
which stores a short string's length, is shared with the
ml_.capacity field).</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">small_</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Large strings are just refcounted</p></td><td class="code"><div class="highlight"><pre>        <span class="k">const</span> <span class="kt">size_t</span> <span class="n">byteSize</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byteSize</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Medium strings are copied eagerly. Don't forget to allocate
one extra Char for the null terminator.</p></td><td class="code"><div class="highlight"><pre>          <span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span> <span class="o">=</span> <span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">size_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="mi">2</span><span class="p">];</span>
          <span class="nl">copyTwo:</span>
          <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">=</span> <span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">size_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
          <span class="nl">copyOne:</span>
          <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">=</span> <span class="o">*</span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">**&gt;</span><span class="p">(</span><span class="n">const_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">byteSize</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>1 for terminator</p></td><td class="code"><div class="highlight"><pre>          <span class="k">goto</span> <span class="n">copyTwo</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>No need for writeTerminator() here, we copied one extra
element just above.</p></td><td class="code"><div class="highlight"><pre>          <span class="k">goto</span> <span class="n">copyOne</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">setSmallSize</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">maxMediumSize</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Just copy, leave the goner in peace</p></td><td class="code"><div class="highlight"><pre>      <span class="k">auto</span> <span class="k">const</span> <span class="n">allocSize</span> <span class="o">=</span> <span class="n">goodMallocSize</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">));</span>
      <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">checkedMalloc</span><span class="p">(</span><span class="n">allocSize</span><span class="p">));</span>
      <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">);</span>
      <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
      <span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span> <span class="o">=</span> <span class="p">(</span><span class="n">allocSize</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">isMedium</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Take goner's guts</p></td><td class="code"><div class="highlight"><pre>      <span class="kt">size_t</span> <span class="n">effectiveCapacity</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
      <span class="k">auto</span> <span class="k">const</span> <span class="n">newRC</span> <span class="o">=</span> <span class="n">RefCounted</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span> <span class="n">effectiveCapacity</span><span class="p">);</span>
      <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">=</span> <span class="n">newRC</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">;</span>
      <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
      <span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span> <span class="o">=</span> <span class="n">effectiveCapacity</span> <span class="o">|</span> <span class="n">isLarge</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">writeTerminator</span><span class="p">();</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">size</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">(),</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="o">~</span><span class="n">fbstring_core</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="k">const</span> <span class="n">c</span> <span class="o">=</span> <span class="n">category</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">isSmall</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">isMedium</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">free</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">RefCounted</span><span class="o">::</span><span class="n">decrementRefs</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Clean goner's carcass</p></td><td class="code"><div class="highlight"><pre>  <span class="n">fbstring_core</span><span class="p">(</span><span class="n">Char</span> <span class="o">*</span><span class="k">const</span> <span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
                <span class="k">const</span> <span class="kt">size_t</span> <span class="n">capacity</span><span class="p">,</span>
                <span class="n">AcquireMallocatedString</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">);</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Simplest case first: small strings are bitblitted</p></td><td class="code"><div class="highlight"><pre>      <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
      <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
      <span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span> <span class="o">=</span> <span class="n">capacity</span> <span class="o">|</span> <span class="n">isMedium</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Layout is: Char* data<em>, size</em>t size<em>, size</em>t capacity_</p></td><td class="code"><div class="highlight"><pre>      <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
      <span class="n">setSmallSize</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>sizeof(size_t) must be a power of 2</p></td><td class="code"><div class="highlight"><pre>  <span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">fbstring_core</span> <span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="k">const</span> <span class="n">t</span> <span class="o">=</span> <span class="n">ml_</span><span class="p">;</span>
    <span class="n">ml_</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">ml_</span><span class="p">;</span>
    <span class="n">rhs</span><span class="p">.</span><span class="n">ml_</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>If data is aligned, use fast word-wise copying. Otherwise,
use conservative memcpy.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span> <span class="n">data</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">c_str</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">Char</span> <span class="o">*</span> <span class="n">mutable_data</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="k">const</span> <span class="n">c</span> <span class="o">=</span> <span class="n">category</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">isSmall</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">small_</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">isMedium</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">isLarge</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">isLarge</span> <span class="o">&amp;&amp;</span> <span class="n">RefCounted</span><span class="o">::</span><span class="n">refs</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Copy one word (64 bits) at a time</p></td><td class="code"><div class="highlight"><pre>      <span class="kt">size_t</span> <span class="n">effectiveCapacity</span> <span class="o">=</span> <span class="n">ml_</span><span class="p">.</span><span class="n">capacity</span><span class="p">();</span>
      <span class="k">auto</span> <span class="k">const</span> <span class="n">newRC</span> <span class="o">=</span> <span class="n">RefCounted</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="o">&amp;</span> <span class="n">effectiveCapacity</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Copy three words</p></td><td class="code"><div class="highlight"><pre>      <span class="n">assert</span><span class="p">(</span><span class="n">effectiveCapacity</span> <span class="o">&gt;=</span> <span class="n">ml_</span><span class="p">.</span><span class="n">capacity</span><span class="p">());</span>
      <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">,</span> <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">+</span> <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">newRC</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">);</span>
      <span class="n">RefCounted</span><span class="o">::</span><span class="n">decrementRefs</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">);</span>
      <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">=</span> <span class="n">newRC</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Copy two words</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span> <span class="n">c_str</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="k">const</span> <span class="n">c</span> <span class="o">=</span> <span class="n">category</span><span class="p">();</span>
<span class="cp">#ifdef FBSTRING_PERVERSE</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">isSmall</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">small_</span><span class="p">[</span><span class="n">smallSize</span><span class="p">()]</span> <span class="o">==</span> <span class="n">TERMINATOR</span> <span class="o">||</span> <span class="n">smallSize</span><span class="p">()</span> <span class="o">==</span> <span class="n">maxSmallSize</span>
             <span class="o">||</span> <span class="n">small_</span><span class="p">[</span><span class="n">smallSize</span><span class="p">()]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>
      <span class="n">small_</span><span class="p">[</span><span class="n">smallSize</span><span class="p">()]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">small_</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">isMedium</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">isLarge</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">[</span><span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">]</span> <span class="o">==</span> <span class="n">TERMINATOR</span> <span class="o">||</span> <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">[</span><span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>
    <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">[</span><span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="cp">#elif defined(FBSTRING_CONSERVATIVE)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">isSmall</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">small_</span><span class="p">[</span><span class="n">smallSize</span><span class="p">()]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">small_</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">isMedium</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">isLarge</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">[</span><span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>
<span class="cp">#else</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">isSmall</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">small_</span><span class="p">[</span><span class="n">smallSize</span><span class="p">()]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">small_</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">isMedium</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">isLarge</span><span class="p">);</span>
    <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">[</span><span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">shrink</span><span class="p">(</span><span class="k">const</span> <span class="kt">size_t</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isSmall</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>Copy one word</p></td><td class="code"><div class="highlight"><pre>      <span class="n">assert</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;=</span> <span class="n">smallSize</span><span class="p">());</span>
      <span class="n">setSmallSize</span><span class="p">(</span><span class="n">smallSize</span><span class="p">()</span> <span class="o">-</span> <span class="n">delta</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isMedium</span> <span class="o">||</span> <span class="n">RefCounted</span><span class="o">::</span><span class="n">refs</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>Medium strings are allocated normally. Don't forget to
allocate one extra Char for the terminating null.</p></td><td class="code"><div class="highlight"><pre>      <span class="n">assert</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">&gt;=</span> <span class="n">delta</span><span class="p">);</span>
      <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">-=</span> <span class="n">delta</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">&gt;=</span> <span class="n">delta</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>Large strings are allocated differently</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fbstring_core</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">,</span> <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">-</span> <span class="n">delta</span><span class="p">).</span><span class="n">swap</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>Snatches a previously mallocated string. The parameter "size"
is the size of the string, and the parameter "capacity" is the size
of the mallocated block.  The string must be \0-terminated, so
data[size] == '\0' and capacity >= size + 1.</p>

<p>So if you want a 2-character string, pass malloc(3) as "data", pass 2 as
"size", and pass 3 as "capacity".</p></td><td class="code"><div class="highlight"><pre>      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">writeTerminator</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">reserve</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">minCapacity</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isLarge</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>Use the medium string storage</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">RefCounted</span><span class="o">::</span><span class="n">refs</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>No need for the memory</p></td><td class="code"><div class="highlight"><pre>        <span class="n">minCapacity</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">minCapacity</span><span class="p">,</span> <span class="n">ml_</span><span class="p">.</span><span class="n">capacity</span><span class="p">());</span>
        <span class="k">auto</span> <span class="k">const</span> <span class="n">newRC</span> <span class="o">=</span> <span class="n">RefCounted</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="o">&amp;</span> <span class="n">minCapacity</span><span class="p">);</span>
        <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">,</span> <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">+</span> <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                   <span class="n">newRC</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>swap below doesn't test whether &amp;rhs == this (and instead
potentially does extra work) on the premise that the rarity of
that situation actually makes the check more expensive than is
worth.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">RefCounted</span><span class="o">::</span><span class="n">decrementRefs</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">);</span>
        <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">=</span> <span class="n">newRC</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">;</span>
        <span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span> <span class="o">=</span> <span class="n">minCapacity</span> <span class="o">|</span> <span class="n">isLarge</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>In C++11 data() and c_str() are 100% equivalent.</p></td><td class="code"><div class="highlight"><pre>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>Ensure unique.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">minCapacity</span> <span class="o">&gt;</span> <span class="n">ml_</span><span class="p">.</span><span class="n">capacity</span><span class="p">())</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>If this fails, someone placed the wrong capacity in an
fbstring.</p></td><td class="code"><div class="highlight"><pre>          <span class="k">auto</span> <span class="k">const</span> <span class="n">newRC</span> <span class="o">=</span>
               <span class="n">RefCounted</span><span class="o">::</span><span class="n">reallocate</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">,</span> <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">,</span>
                                      <span class="n">ml_</span><span class="p">.</span><span class="n">capacity</span><span class="p">(),</span> <span class="n">minCapacity</span><span class="p">);</span>
          <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">=</span> <span class="n">newRC</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">;</span>
          <span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span> <span class="o">=</span> <span class="n">minCapacity</span> <span class="o">|</span> <span class="n">isLarge</span><span class="p">;</span>
          <span class="n">writeTerminator</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">minCapacity</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isMedium</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>No need to call writeTerminator(), we have + 1 above.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">minCapacity</span> <span class="o">&lt;=</span> <span class="n">ml_</span><span class="p">.</span><span class="n">capacity</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span> <span class="c1">// nothing to do, there&#39;s enough room</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">minCapacity</span> <span class="o">&lt;=</span> <span class="n">maxMediumSize</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>Check for underflow</p></td><td class="code"><div class="highlight"><pre>        <span class="kt">size_t</span> <span class="n">capacityBytes</span> <span class="o">=</span> <span class="n">goodMallocSize</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">minCapacity</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">));</span>
        <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">Char</span> <span class="o">*&gt;</span><span class="p">(</span>
          <span class="n">smartRealloc</span><span class="p">(</span>
            <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">,</span>
            <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">),</span>
            <span class="n">ml_</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">),</span>
            <span class="n">capacityBytes</span><span class="p">));</span>
        <span class="n">writeTerminator</span><span class="p">();</span>
        <span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacityBytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">isMedium</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>Medium strings and unique large strings need no special
handling.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">fbstring_core</span> <span class="n">nascent</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>Shared large string, must make unique. This is because of the
durn terminator must be written, which may trample the shared
data.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">nascent</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">minCapacity</span><span class="p">);</span>
        <span class="n">nascent</span><span class="p">.</span><span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">=</span> <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">;</span>
        <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">,</span> <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">+</span> <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">,</span>
                                  <span class="n">nascent</span><span class="p">.</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">);</span>
        <span class="n">nascent</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">);</span>
        <span class="n">writeTerminator</span><span class="p">();</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">minCapacity</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isSmall</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">minCapacity</span> <span class="o">&gt;</span> <span class="n">maxMediumSize</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>No need to write the terminator.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">auto</span> <span class="k">const</span> <span class="n">newRC</span> <span class="o">=</span> <span class="n">RefCounted</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="o">&amp;</span> <span class="n">minCapacity</span><span class="p">);</span>
        <span class="k">auto</span> <span class="k">const</span> <span class="n">size</span> <span class="o">=</span> <span class="n">smallSize</span><span class="p">();</span>
        <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span><span class="n">small_</span><span class="p">,</span> <span class="n">small_</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">newRC</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>Ensure unique</p></td><td class="code"><div class="highlight"><pre>        <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">=</span> <span class="n">newRC</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">;</span>
        <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
        <span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span> <span class="o">=</span> <span class="n">minCapacity</span> <span class="o">|</span> <span class="n">isLarge</span><span class="p">;</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">minCapacity</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">minCapacity</span> <span class="o">&gt;</span> <span class="n">maxSmallSize</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>We must make it unique regardless; in-place reallocation is
useless if the string is shared. In order to not surprise
people, reserve the new block at current capacity or
more. That way, a string's capacity never shrinks after a
call to reserve.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">auto</span> <span class="k">const</span> <span class="n">allocSizeBytes</span> <span class="o">=</span>
          <span class="n">goodMallocSize</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">minCapacity</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">));</span>
        <span class="k">auto</span> <span class="k">const</span> <span class="n">data</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">checkedMalloc</span><span class="p">(</span><span class="n">allocSizeBytes</span><span class="p">));</span>
        <span class="k">auto</span> <span class="k">const</span> <span class="n">size</span> <span class="o">=</span> <span class="n">smallSize</span><span class="p">();</span>
        <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span><span class="n">small_</span><span class="p">,</span> <span class="n">small_</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>Done with the old data. No need to call writeTerminator(),
we have + 1 above.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
        <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
        <span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span> <span class="o">=</span> <span class="p">(</span><span class="n">allocSizeBytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">isMedium</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>size remains unchanged</p></td><td class="code"><div class="highlight"><pre>      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">minCapacity</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">expand_noinit</span><span class="p">(</span><span class="k">const</span> <span class="kt">size_t</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>String is not shared, so let's try to realloc (if needed)</p></td><td class="code"><div class="highlight"><pre>    <span class="n">assert</span><span class="p">(</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">());</span>
    <span class="kt">size_t</span> <span class="n">sz</span><span class="p">,</span> <span class="n">newSz</span><span class="p">,</span> <span class="n">cp</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isSmall</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sz</span> <span class="o">=</span> <span class="n">smallSize</span><span class="p">();</span>
      <span class="n">newSz</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">delta</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">newSz</span> <span class="o">&lt;=</span> <span class="n">maxSmallSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">setSmallSize</span><span class="p">(</span><span class="n">newSz</span><span class="p">);</span>
        <span class="n">writeTerminator</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">cp</span> <span class="o">=</span> <span class="n">maxSmallSize</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">sz</span> <span class="o">=</span> <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">;</span>
      <span class="n">newSz</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">delta</span><span class="p">;</span>
      <span class="n">cp</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">newSz</span> <span class="o">&gt;</span> <span class="n">cp</span><span class="p">)</span> <span class="n">reserve</span><span class="p">(</span><span class="n">newSz</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">newSz</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>Asking for more memory</p></td><td class="code"><div class="highlight"><pre>    <span class="n">assert</span><span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isMedium</span> <span class="o">||</span> <span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isLarge</span><span class="p">);</span>
    <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">=</span> <span class="n">newSz</span><span class="p">;</span>
    <span class="n">writeTerminator</span><span class="p">();</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">newSz</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">push_back</span><span class="p">(</span><span class="n">Char</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">());</span>
    <span class="kt">size_t</span> <span class="n">sz</span><span class="p">,</span> <span class="n">cp</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isSmall</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sz</span> <span class="o">=</span> <span class="n">smallSize</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&lt;</span> <span class="n">maxSmallSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">setSmallSize</span><span class="p">(</span><span class="n">sz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">small_</span><span class="p">[</span><span class="n">sz</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
        <span class="n">writeTerminator</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">reserve</span><span class="p">(</span><span class="n">maxSmallSize</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">sz</span> <span class="o">=</span> <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">;</span>
      <span class="n">cp</span> <span class="o">=</span> <span class="n">ml_</span><span class="p">.</span><span class="n">capacity</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">==</span> <span class="n">cp</span><span class="p">)</span> <span class="n">reserve</span><span class="p">(</span><span class="n">cp</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">sz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>String is not shared</p></td><td class="code"><div class="highlight"><pre>    <span class="n">assert</span><span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isMedium</span> <span class="o">||</span> <span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isLarge</span><span class="p">);</span>
    <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">mutable_data</span><span class="p">()[</span><span class="n">sz</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="n">writeTerminator</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isSmall</span> <span class="o">?</span> <span class="n">smallSize</span><span class="p">()</span> <span class="o">:</span> <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">capacity</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">category</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">isSmall</span>:
        <span class="k">return</span> <span class="n">maxSmallSize</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">isLarge</span>:</pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>Keep the string at medium size. Don't forget to allocate
one extra Char for the terminating null.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">RefCounted</span><span class="o">::</span><span class="n">refs</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">;</span>
      <span class="nl">default:</span> <span class="p">{}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ml_</span><span class="p">.</span><span class="n">capacity</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">bool</span> <span class="n">isShared</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isLarge</span> <span class="o">&amp;&amp;</span> <span class="n">RefCounted</span><span class="o">::</span><span class="n">refs</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

<span class="cp">#ifdef FBSTRING_PERVERSE</span>
  <span class="k">enum</span> <span class="p">{</span> <span class="n">TERMINATOR</span> <span class="o">=</span> <span class="sc">&#39;^&#39;</span> <span class="p">};</span>
<span class="cp">#else</span>
  <span class="k">enum</span> <span class="p">{</span> <span class="n">TERMINATOR</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span> <span class="p">};</span>
<span class="cp">#endif</span>

  <span class="kt">void</span> <span class="n">writeTerminator</span><span class="p">()</span> <span class="p">{</span>
<span class="cp">#if defined(FBSTRING_PERVERSE) || defined(FBSTRING_CONSERVATIVE)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isSmall</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const</span> <span class="k">auto</span> <span class="n">s</span> <span class="o">=</span> <span class="n">smallSize</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">maxSmallSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">small_</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">TERMINATOR</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">ml_</span><span class="p">.</span><span class="n">data_</span><span class="p">[</span><span class="n">ml_</span><span class="p">.</span><span class="n">size_</span><span class="p">]</span> <span class="o">=</span> <span class="n">TERMINATOR</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

<span class="nl">private:</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>Conversion from medium to large string</p></td><td class="code"><div class="highlight"><pre>  <span class="n">fbstring_core</span> <span class="o">&amp;</span> <span class="n">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">fbstring_core</span> <span class="o">&amp;</span> <span class="n">rhs</span><span class="p">);</span>

  <span class="k">struct</span> <span class="n">MediumLarge</span> <span class="p">{</span>
    <span class="n">Char</span> <span class="o">*</span> <span class="n">data_</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">size_</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">capacity_</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="n">capacity</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">capacity_</span> <span class="o">&amp;</span> <span class="n">capacityExtractMask</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">struct</span> <span class="n">RefCounted</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span> <span class="n">refCount_</span><span class="p">;</span>
    <span class="n">Char</span> <span class="n">data_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

    <span class="k">static</span> <span class="n">RefCounted</span> <span class="o">*</span> <span class="n">fromData</span><span class="p">(</span><span class="n">Char</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">RefCounted</span><span class="o">*&gt;</span><span class="p">(</span>
        <span class="n">static_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span>
          <span class="n">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">static_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
          <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">RefCounted</span><span class="p">,</span> <span class="n">data_</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="kt">size_t</span> <span class="n">refs</span><span class="p">(</span><span class="n">Char</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">fromData</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">refCount_</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="kt">void</span> <span class="n">incrementRefs</span><span class="p">(</span><span class="n">Char</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fromData</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">refCount_</span><span class="p">.</span><span class="n">fetch_add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_acq_rel</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="kt">void</span> <span class="n">decrementRefs</span><span class="p">(</span><span class="n">Char</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="k">const</span> <span class="n">dis</span> <span class="o">=</span> <span class="n">fromData</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="kt">size_t</span> <span class="n">oldcnt</span> <span class="o">=</span> <span class="n">dis</span><span class="o">-&gt;</span><span class="n">refCount_</span><span class="p">.</span><span class="n">fetch_sub</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_acq_rel</span><span class="p">);</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">oldcnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">oldcnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">dis</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="n">RefCounted</span> <span class="o">*</span> <span class="n">create</span><span class="p">(</span><span class="kt">size_t</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Will recurse to another branch of this function</p></td><td class="code"><div class="highlight"><pre>      <span class="k">const</span> <span class="kt">size_t</span> <span class="n">allocSize</span> <span class="o">=</span> <span class="n">goodMallocSize</span><span class="p">(</span>
        <span class="k">sizeof</span><span class="p">(</span><span class="n">RefCounted</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">));</span>
      <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">RefCounted</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">checkedMalloc</span><span class="p">(</span><span class="n">allocSize</span><span class="p">));</span>
      <span class="n">result</span><span class="o">-&gt;</span><span class="n">refCount_</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
      <span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">allocSize</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RefCounted</span><span class="p">))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="n">RefCounted</span> <span class="o">*</span> <span class="n">create</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const</span> <span class="kt">size_t</span> <span class="n">effectiveSize</span> <span class="o">=</span> <span class="o">*</span><span class="n">size</span><span class="p">;</span>
      <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
      <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">effectiveSize</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">data_</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="n">RefCounted</span> <span class="o">*</span> <span class="n">reallocate</span><span class="p">(</span><span class="n">Char</span> <span class="o">*</span><span class="k">const</span> <span class="n">data</span><span class="p">,</span>
                                   <span class="k">const</span> <span class="kt">size_t</span> <span class="n">currentSize</span><span class="p">,</span>
                                   <span class="k">const</span> <span class="kt">size_t</span> <span class="n">currentCapacity</span><span class="p">,</span>
                                   <span class="k">const</span> <span class="kt">size_t</span> <span class="n">newCapacity</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">newCapacity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">newCapacity</span> <span class="o">&gt;</span> <span class="n">currentSize</span><span class="p">);</span>
      <span class="k">auto</span> <span class="k">const</span> <span class="n">dis</span> <span class="o">=</span> <span class="n">fromData</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">dis</span><span class="o">-&gt;</span><span class="n">refCount_</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>large</p></td><td class="code"><div class="highlight"><pre>      <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">RefCounted</span><span class="o">*&gt;</span><span class="p">(</span>
             <span class="n">smartRealloc</span><span class="p">(</span><span class="n">dis</span><span class="p">,</span>
                          <span class="k">sizeof</span><span class="p">(</span><span class="n">RefCounted</span><span class="p">)</span> <span class="o">+</span> <span class="n">currentSize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">),</span>
                          <span class="k">sizeof</span><span class="p">(</span><span class="n">RefCounted</span><span class="p">)</span> <span class="o">+</span> <span class="n">currentCapacity</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">),</span>
                          <span class="k">sizeof</span><span class="p">(</span><span class="n">RefCounted</span><span class="p">)</span> <span class="o">+</span> <span class="n">newCapacity</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">)));</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">refCount_</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">union</span> <span class="p">{</span>
    <span class="n">mutable</span> <span class="n">Char</span> <span class="n">small_</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MediumLarge</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">)];</span>
    <span class="n">mutable</span> <span class="n">MediumLarge</span> <span class="n">ml_</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">enum</span> <span class="p">{</span>
    <span class="n">lastChar</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MediumLarge</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">maxSmallSize</span> <span class="o">=</span> <span class="n">lastChar</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">),</span>
    <span class="n">maxMediumSize</span> <span class="o">=</span> <span class="mi">254</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">),</span>            <span class="c1">// coincides with the small</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>No need for writeTerminator(), we wrote it above with + 1.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">categoryExtractMask</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">?</span> <span class="mh">0xC0000000</span> <span class="o">:</span> <span class="mh">0xC000000000000000</span><span class="p">,</span>
    <span class="n">capacityExtractMask</span> <span class="o">=</span> <span class="o">~</span><span class="n">categoryExtractMask</span><span class="p">,</span>
  <span class="p">};</span>
  <span class="n">static_assert</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MediumLarge</span><span class="p">)</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Char</span><span class="p">)),</span>
                <span class="s">&quot;Corrupt memory layout for fbstring.&quot;</span><span class="p">);</span>

  <span class="k">enum</span> <span class="n">Category</span> <span class="p">{</span>
    <span class="n">isSmall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">isMedium</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">?</span> <span class="mh">0x80000000</span> <span class="o">:</span> <span class="mh">0x8000000000000000</span><span class="p">,</span>
    <span class="n">isLarge</span> <span class="o">=</span>  <span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">?</span> <span class="mh">0x40000000</span> <span class="o">:</span> <span class="mh">0x4000000000000000</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="n">Category</span> <span class="n">category</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>medium
Don't forget to allocate one extra Char for the terminating null</p></td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ml_</span><span class="p">.</span><span class="n">capacity_</span> <span class="o">&amp;</span> <span class="n">categoryExtractMask</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">smallSize</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">category</span><span class="p">()</span> <span class="o">==</span> <span class="n">isSmall</span> <span class="o">&amp;&amp;</span> <span class="n">small_</span><span class="p">[</span><span class="n">maxSmallSize</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">maxSmallSize</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">maxSmallSize</span><span class="p">)</span>
      <span class="o">-</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">small_</span><span class="p">[</span><span class="n">maxSmallSize</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">setSmallSize</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>No need for writeTerminator(), we wrote it above with + 1.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">assert</span><span class="p">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="n">maxSmallSize</span><span class="p">);</span>
    <span class="n">small_</span><span class="p">[</span><span class="n">maxSmallSize</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxSmallSize</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#ifndef _LIBSTDCXX_FBSTRING</span>
<span class="cm">/**</span>
<span class="cm"> * Dummy fbstring core that uses an actual std::string. This doesn&#39;t</span>
<span class="cm"> * make any sense - it&#39;s just for testing purposes.</span>
<span class="cm"> */</span>
<span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">Char</span><span class="o">&gt;</span>
<span class="n">class</span> <span class="n">dummy_fbstring_core</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">dummy_fbstring_core</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>
  <span class="n">dummy_fbstring_core</span><span class="p">(</span><span class="k">const</span> <span class="n">dummy_fbstring_core</span><span class="o">&amp;</span> <span class="n">another</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">backend_</span><span class="p">(</span><span class="n">another</span><span class="p">.</span><span class="n">backend_</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>
  <span class="n">dummy_fbstring_core</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">backend_</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">dummy_fbstring_core</span> <span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">backend_</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">backend_</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span> <span class="n">data</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">backend_</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">Char</span> <span class="o">*</span> <span class="n">mutable_data</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>small
Nothing to do, everything stays put</p></td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="o">&amp;*</span><span class="n">backend_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">shrink</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">());</span>
    <span class="n">backend_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">delta</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">expand_noinit</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">backend_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">delta</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">push_back</span><span class="p">(</span><span class="n">Char</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">backend_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">size_t</span> <span class="n">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">backend_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kt">size_t</span> <span class="n">capacity</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">backend_</span><span class="p">.</span><span class="n">capacity</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">bool</span> <span class="n">isShared</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">reserve</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">minCapacity</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">backend_</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">minCapacity</span><span class="p">);</span>
  <span class="p">}</span>

<span class="nl">private:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">backend_</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="c1">// !_LIBSTDCXX_FBSTRING</span>

<span class="cm">/**</span>
<span class="cm"> * This is the basic_string replacement. For conformity,</span>
<span class="cm"> * basic_fbstring takes the same template parameters, plus the last</span>
<span class="cm"> * one which is the core.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef _LIBSTDCXX_FBSTRING</span>
<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">Storage</span><span class="o">&gt;</span>
<span class="cp">#else</span>
<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span>
          <span class="n">class</span> <span class="n">T</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
          <span class="n">class</span> <span class="n">A</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
          <span class="n">class</span> <span class="n">Storage</span> <span class="o">=</span> <span class="n">fbstring_core</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="o">&gt;</span>
<span class="cp">#endif</span>
<span class="n">class</span> <span class="n">basic_fbstring</span> <span class="p">{</span>

  <span class="k">static</span> <span class="kt">void</span> <span class="n">enforce</span><span class="p">(</span>
      <span class="n">bool</span> <span class="n">condition</span><span class="p">,</span>
      <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">throw_exc</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">),</span>
      <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">condition</span><span class="p">)</span> <span class="n">throw_exc</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">bool</span> <span class="n">isSane</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span>
      <span class="n">begin</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
      <span class="n">empty</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">empty</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="n">begin</span><span class="p">()</span> <span class="o">==</span> <span class="n">end</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
      <span class="n">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">max_size</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
      <span class="n">capacity</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">max_size</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
      <span class="n">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">capacity</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="n">begin</span><span class="p">()[</span><span class="n">size</span><span class="p">()]</span> <span class="o">==</span> <span class="n">Storage</span><span class="o">::</span><span class="n">TERMINATOR</span> <span class="o">||</span> <span class="n">begin</span><span class="p">()[</span><span class="n">size</span><span class="p">()]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">struct</span> <span class="n">Invariant</span><span class="p">;</span>
  <span class="n">friend</span> <span class="k">struct</span> <span class="n">Invariant</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">Invariant</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="n">explicit</span> <span class="n">Invariant</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span> <span class="o">:</span> <span class="n">s_</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">s_</span><span class="p">.</span><span class="n">isSane</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="o">~</span><span class="n">Invariant</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">s_</span><span class="p">.</span><span class="n">isSane</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="nl">private:</span>
    <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">s_</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="n">explicit</span> <span class="n">Invariant</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>
    <span class="n">Invariant</span><span class="o">&amp;</span> <span class="n">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">Invariant</span><span class="o">&amp;</span><span class="p">);</span>
  <span class="p">};</span>

<span class="nl">public:</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>Strategy is simple: make room, then change size</p></td><td class="code"><div class="highlight"><pre>  <span class="k">typedef</span> <span class="n">T</span> <span class="n">traits_type</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="kr">typename</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">char_type</span> <span class="n">value_type</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">A</span> <span class="n">allocator_type</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="kr">typename</span> <span class="n">A</span><span class="o">::</span><span class="n">size_type</span> <span class="n">size_type</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="kr">typename</span> <span class="n">A</span><span class="o">::</span><span class="n">difference_type</span> <span class="n">difference_type</span><span class="p">;</span>

  <span class="k">typedef</span> <span class="kr">typename</span> <span class="n">A</span><span class="o">::</span><span class="n">reference</span> <span class="n">reference</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="kr">typename</span> <span class="n">A</span><span class="o">::</span><span class="n">const_reference</span> <span class="n">const_reference</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="kr">typename</span> <span class="n">A</span><span class="o">::</span><span class="n">pointer</span> <span class="n">pointer</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="kr">typename</span> <span class="n">A</span><span class="o">::</span><span class="n">const_pointer</span> <span class="n">const_pointer</span><span class="p">;</span>

  <span class="k">typedef</span> <span class="n">E</span><span class="o">*</span> <span class="n">iterator</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="k">const</span> <span class="n">E</span><span class="o">*</span> <span class="n">const_iterator</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">reverse_iterator</span><span class="o">&lt;</span><span class="n">iterator</span>
<span class="cp">#ifdef NO_ITERATOR_TRAITS</span>
                                <span class="p">,</span> <span class="n">value_type</span>
<span class="cp">#endif</span>
                                <span class="o">&gt;</span> <span class="n">reverse_iterator</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">reverse_iterator</span><span class="o">&lt;</span><span class="n">const_iterator</span>
<span class="cp">#ifdef NO_ITERATOR_TRAITS</span>
                                <span class="p">,</span> <span class="k">const</span> <span class="n">value_type</span>
<span class="cp">#endif</span>
                                <span class="o">&gt;</span> <span class="n">const_reverse_iterator</span><span class="p">;</span>

  <span class="k">static</span> <span class="k">const</span> <span class="n">size_type</span> <span class="n">npos</span><span class="p">;</span>                     <span class="c1">// = size_type(-1)</span>

<span class="nl">private:</span>
  <span class="k">static</span> <span class="kt">void</span> <span class="n">procrustes</span><span class="p">(</span><span class="n">size_type</span><span class="o">&amp;</span> <span class="n">n</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">nmax</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">)</span> <span class="n">n</span> <span class="o">=</span> <span class="n">nmax</span><span class="p">;</span>
  <span class="p">}</span>

<span class="nl">public:</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>Category can't be small - we took care of that above</p></td><td class="code"><div class="highlight"><pre>  <span class="n">explicit</span> <span class="n">basic_fbstring</span><span class="p">(</span><span class="k">const</span> <span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">())</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">store_</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">store_</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>Category can't be small - we took care of that above</p></td><td class="code"><div class="highlight"><pre>  <span class="n">basic_fbstring</span><span class="p">(</span><span class="n">basic_fbstring</span><span class="o">&amp;&amp;</span> <span class="n">goner</span><span class="p">)</span> <span class="o">:</span> <span class="n">store_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">goner</span><span class="p">.</span><span class="n">store_</span><span class="p">))</span> <span class="p">{</span>
  <span class="p">}</span>

<span class="cp">#ifndef _LIBSTDCXX_FBSTRING</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>For large-sized strings, a multi-referenced chunk has no
available capacity. This is because any attempt to append
data would trigger a new allocation.</p></td><td class="code"><div class="highlight"><pre>  <span class="cm">/* implicit */</span> <span class="n">basic_fbstring</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">store_</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="cp">#endif</span>

  <span class="n">basic_fbstring</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span>
                 <span class="n">size_type</span> <span class="n">n</span> <span class="o">=</span> <span class="n">npos</span><span class="p">,</span> <span class="k">const</span> <span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">assign</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* implicit */</span> <span class="n">basic_fbstring</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">())</span>
      <span class="o">:</span> <span class="n">store_</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span> <span class="o">?</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">:</span> <span class="p">({</span>
          <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">err</span> <span class="o">=</span> <span class="n">__PRETTY_FUNCTION__</span><span class="p">;</span>
          <span class="n">err</span> <span class="o">+=</span> <span class="s">&quot;: null pointer initializer not valid&quot;</span><span class="p">;</span>
          <span class="n">std</span><span class="o">::</span><span class="n">__throw_logic_error</span><span class="p">(</span><span class="n">err</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
          <span class="mi">0</span><span class="p">;</span>
      <span class="p">}))</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">())</span>
      <span class="o">:</span> <span class="n">store_</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="p">(</span><span class="n">size_type</span> <span class="n">n</span><span class="p">,</span> <span class="n">value_type</span> <span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">store_</span><span class="p">.</span><span class="n">expand_noinit</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="k">auto</span> <span class="k">const</span> <span class="n">data</span> <span class="o">=</span> <span class="n">store_</span><span class="p">.</span><span class="n">mutable_data</span><span class="p">();</span>
    <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_fill</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="n">store_</span><span class="p">.</span><span class="n">writeTerminator</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">InIt</span><span class="o">&gt;</span>
  <span class="n">basic_fbstring</span><span class="p">(</span><span class="n">InIt</span> <span class="n">begin</span><span class="p">,</span> <span class="n">InIt</span> <span class="n">end</span><span class="p">,</span>
                 <span class="kr">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">enable_if</span><span class="o">&lt;</span>
                 <span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="kr">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">remove_const</span><span class="o">&lt;</span><span class="n">InIt</span><span class="o">&gt;::</span><span class="n">type</span><span class="p">,</span>
                 <span class="n">value_type</span><span class="o">*&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="n">A</span><span class="o">&gt;::</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">assign</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>Disabled</p></td><td class="code"><div class="highlight"><pre>  <span class="n">basic_fbstring</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">store_</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>Don't forget to allocate one extra Char for the terminating
null. In this case, however, one Char is already part of the
struct.</p></td><td class="code"><div class="highlight"><pre>  <span class="n">basic_fbstring</span><span class="p">(</span><span class="n">value_type</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">c</span><span class="p">,</span>
                 <span class="n">AcquireMallocatedString</span> <span class="n">a</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">store_</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="o">~</span><span class="n">basic_fbstring</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span> <span class="o">&amp;</span> <span class="n">lhs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lhs</span> <span class="o">==</span> <span class="n">this</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="k">const</span> <span class="n">oldSize</span> <span class="o">=</span> <span class="n">size</span><span class="p">();</span>
    <span class="k">auto</span> <span class="k">const</span> <span class="n">srcSize</span> <span class="o">=</span> <span class="n">lhs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">srcSize</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">store_</span><span class="p">.</span><span class="n">isShared</span><span class="p">())</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>Don't forget to allocate one extra Char for the terminating
null. In this case, however, one Char is already part of the
struct.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">oldSize</span> <span class="o">&lt;</span> <span class="n">srcSize</span><span class="p">)</span>
        <span class="n">store_</span><span class="p">.</span><span class="n">expand_noinit</span><span class="p">(</span><span class="n">srcSize</span> <span class="o">-</span> <span class="n">oldSize</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">store_</span><span class="p">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">oldSize</span> <span class="o">-</span> <span class="n">srcSize</span><span class="p">);</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">srcSize</span><span class="p">);</span>
      <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">lhs</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">begin</span><span class="p">());</span>
      <span class="n">store_</span><span class="p">.</span><span class="n">writeTerminator</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>bin size in dlmalloc</p></td><td class="code"><div class="highlight"><pre>      <span class="n">basic_fbstring</span><span class="p">(</span><span class="n">lhs</span><span class="p">).</span><span class="n">swap</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>Assumes little endian</p></td><td class="code"><div class="highlight"><pre>  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">operator</span><span class="o">=</span><span class="p">(</span><span class="n">basic_fbstring</span><span class="o">&amp;&amp;</span> <span class="n">goner</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>Warning: this should work with uninitialized strings too,
so don't assume anything about the previous value of
small_[maxSmallSize].</p></td><td class="code"><div class="highlight"><pre>    <span class="n">this</span><span class="o">-&gt;~</span><span class="n">basic_fbstring</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>assert(!backend_.empty());</p></td><td class="code"><div class="highlight"><pre>    <span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">store_</span><span class="p">)</span> <span class="n">fbstring_core</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">goner</span><span class="p">.</span><span class="n">store_</span><span class="p">));</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

<span class="cp">#ifndef _LIBSTDCXX_FBSTRING</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>types</p></td><td class="code"><div class="highlight"><pre>  <span class="n">basic_fbstring</span> <span class="o">&amp;</span> <span class="n">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">rhs</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>21.3.1 construct/copy/destroy</p></td><td class="code"><div class="highlight"><pre>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">toStdString</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">data</span><span class="p">(),</span> <span class="n">size</span><span class="p">());</span>
  <span class="p">}</span>
<span class="cp">#else</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>Move constructor</p></td><td class="code"><div class="highlight"><pre>  <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">toStdString</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>
<span class="cp">#endif</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">operator</span><span class="o">=</span><span class="p">(</span><span class="n">value_type</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">store_</span><span class="p">.</span><span class="n">expand_noinit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">store_</span><span class="p">.</span><span class="n">isShared</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">basic_fbstring</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">).</span><span class="n">swap</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">store_</span><span class="p">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="n">store_</span><span class="p">.</span><span class="n">mutable_data</span><span class="p">()</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="n">store_</span><span class="p">.</span><span class="n">writeTerminator</span><span class="p">();</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>This is defined for compatibility with std::string</p></td><td class="code"><div class="highlight"><pre>  <span class="n">iterator</span> <span class="n">begin</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">store_</span><span class="p">.</span><span class="n">mutable_data</span><span class="p">();</span> <span class="p">}</span>

  <span class="n">const_iterator</span> <span class="n">begin</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">store_</span><span class="p">.</span><span class="n">data</span><span class="p">();</span> <span class="p">}</span>

  <span class="n">iterator</span> <span class="n">end</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">store_</span><span class="p">.</span><span class="n">mutable_data</span><span class="p">()</span> <span class="o">+</span> <span class="n">store_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">const_iterator</span> <span class="n">end</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">store_</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">store_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">reverse_iterator</span> <span class="n">rbegin</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">reverse_iterator</span><span class="p">(</span><span class="n">end</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">const_reverse_iterator</span> <span class="n">rbegin</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">const_reverse_iterator</span><span class="p">(</span><span class="n">end</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">reverse_iterator</span> <span class="n">rend</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">reverse_iterator</span><span class="p">(</span><span class="n">begin</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">const_reverse_iterator</span> <span class="n">rend</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">const_reverse_iterator</span><span class="p">(</span><span class="n">begin</span><span class="p">());</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>Specialization for const char<em>, const char</em></p></td><td class="code"><div class="highlight"><pre>  <span class="n">value_type</span> <span class="n">front</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="n">begin</span><span class="p">();</span> <span class="p">}</span>
  <span class="n">value_type</span> <span class="n">back</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">empty</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">begin</span><span class="p">()[</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">pop_back</span><span class="p">()</span> <span class="p">{</span> <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">empty</span><span class="p">());</span> <span class="n">store_</span><span class="p">.</span><span class="n">shrink</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>Nonstandard constructor</p></td><td class="code"><div class="highlight"><pre>  <span class="n">size_type</span> <span class="n">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">store_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">length</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">size</span><span class="p">();</span> <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">max_size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">size_type</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">resize</span><span class="p">(</span><span class="k">const</span> <span class="n">size_type</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="n">value_type</span> <span class="n">c</span> <span class="o">=</span> <span class="n">value_type</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">size</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">store_</span><span class="p">.</span><span class="n">shrink</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">n</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>great, just copy the contents</p></td><td class="code"><div class="highlight"><pre>      <span class="k">auto</span> <span class="k">const</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">();</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">capacity</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">auto</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">capacity</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
        <span class="n">store_</span><span class="p">.</span><span class="n">expand_noinit</span><span class="p">(</span><span class="n">delta</span><span class="p">);</span>
        <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_fill</span><span class="p">(</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">end</span><span class="p">(),</span> <span class="n">c</span><span class="p">);</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">store_</span><span class="p">.</span><span class="n">writeTerminator</span><span class="p">();</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">auto</span> <span class="k">const</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
      <span class="n">store_</span><span class="p">.</span><span class="n">expand_noinit</span><span class="p">(</span><span class="n">delta</span><span class="p">);</span>
      <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_fill</span><span class="p">(</span><span class="n">end</span><span class="p">()</span> <span class="o">-</span> <span class="n">delta</span><span class="p">,</span> <span class="n">end</span><span class="p">(),</span> <span class="n">c</span><span class="p">);</span>
      <span class="n">store_</span><span class="p">.</span><span class="n">writeTerminator</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">n</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">capacity</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">store_</span><span class="p">.</span><span class="n">capacity</span><span class="p">();</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">reserve</span><span class="p">(</span><span class="n">size_type</span> <span class="n">res_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">res_arg</span> <span class="o">&lt;=</span> <span class="n">max_size</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_length_error</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">store_</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">res_arg</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">clear</span><span class="p">()</span> <span class="p">{</span> <span class="n">resize</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="p">}</span>

  <span class="n">bool</span> <span class="n">empty</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>need to reallocate, so we may as well create a brand new string</p></td><td class="code"><div class="highlight"><pre>  <span class="n">const_reference</span> <span class="n">operator</span><span class="p">[](</span><span class="n">size_type</span> <span class="n">pos</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">c_str</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">reference</span> <span class="n">operator</span><span class="p">[](</span><span class="n">size_type</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="n">size</span><span class="p">())</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>Move assignment</p></td><td class="code"><div class="highlight"><pre>      <span class="n">c_str</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">const_reference</span> <span class="n">at</span><span class="p">(</span><span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">)[</span><span class="n">n</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="n">reference</span> <span class="n">at</span><span class="p">(</span><span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">)[</span><span class="n">n</span><span class="p">];</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><p>No need of this anymore</p></td><td class="code"><div class="highlight"><pre>  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">operator</span><span class="o">+=</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">append</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">operator</span><span class="o">+=</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">operator</span><span class="o">+=</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">push_back</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">append</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="k">auto</span> <span class="n">desiredSize</span> <span class="o">=</span> <span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="cp">#endif</span>
    <span class="n">append</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">desiredSize</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">append</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">,</span> <span class="k">const</span> <span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span>
                         <span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">size_type</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">sz</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">procrustes</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">sz</span> <span class="o">-</span> <span class="n">pos</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">append</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">append</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="k">auto</span> <span class="n">oldSize</span> <span class="o">=</span> <span class="n">size</span><span class="p">();</span>
<span class="cp">#endif</span>
    <span class="n">Invariant</span> <span class="n">checker</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">);</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">checker</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">less_equal</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*&gt;</span> <span class="n">le</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">le</span><span class="p">(</span><span class="n">data</span><span class="p">(),</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">le</span><span class="p">(</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">size</span><span class="p">(),</span> <span class="n">s</span><span class="p">))</span> <span class="p">{</span><span class="c1">// aliasing</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">le</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">size</span><span class="p">()));</span>
      <span class="k">const</span> <span class="n">size_type</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">data</span><span class="p">();</span>
      <span class="n">store_</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>Move the goner into this</p></td><td class="code"><div class="highlight"><pre>      <span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">store_</span><span class="p">.</span><span class="n">expand_noinit</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">end</span><span class="p">()</span> <span class="o">-</span> <span class="n">n</span><span class="p">);</span>
    <span class="n">store_</span><span class="p">.</span><span class="n">writeTerminator</span><span class="p">();</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">oldSize</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">append</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">append</span><span class="p">(</span><span class="n">size_type</span> <span class="n">n</span><span class="p">,</span> <span class="n">value_type</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">resize</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">template</span><span class="o">&lt;</span><span class="n">class</span> <span class="n">InputIterator</span><span class="o">&gt;</span>
  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">append</span><span class="p">(</span><span class="n">InputIterator</span> <span class="n">first</span><span class="p">,</span> <span class="n">InputIterator</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">insert</span><span class="p">(</span><span class="n">end</span><span class="p">(),</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">push_back</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>             <span class="c1">// primitive</span>
    <span class="n">store_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">assign</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">str</span> <span class="o">==</span> <span class="n">this</span><span class="p">)</span> <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">assign</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">,</span> <span class="k">const</span> <span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span>
                         <span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">size_type</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">sz</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">procrustes</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">sz</span> <span class="o">-</span> <span class="n">pos</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">assign</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Invariant</span> <span class="n">checker</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">);</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">checker</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">begin</span><span class="p">());</span>
      <span class="n">resize</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">n</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">const</span> <span class="n">value_type</span> <span class="o">*</span><span class="k">const</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">size</span><span class="p">();</span>
      <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">begin</span><span class="p">());</span>
      <span class="n">append</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">size</span><span class="p">());</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">n</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">store_</span><span class="p">.</span><span class="n">writeTerminator</span><span class="p">();</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">n</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">assign</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">assign</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">ItOrLength</span><span class="p">,</span> <span class="n">class</span> <span class="n">ItOrChar</span><span class="o">&gt;</span>
  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">assign</span><span class="p">(</span><span class="n">ItOrLength</span> <span class="n">first_or_n</span><span class="p">,</span> <span class="n">ItOrChar</span> <span class="n">last_or_c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="n">begin</span><span class="p">(),</span> <span class="n">end</span><span class="p">(),</span> <span class="n">first_or_n</span><span class="p">,</span> <span class="n">last_or_c</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">insert</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos1</span><span class="p">,</span> <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">insert</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">insert</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos1</span><span class="p">,</span> <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">,</span>
                         <span class="n">size_type</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">pos2</span> <span class="o">&lt;=</span> <span class="n">str</span><span class="p">.</span><span class="n">length</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">procrustes</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">-</span> <span class="n">pos2</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">insert</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">insert</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span> <span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">length</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">insert</span><span class="p">(</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">insert</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span> <span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">insert</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n</span><span class="p">,</span> <span class="n">value_type</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">length</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">insert</span><span class="p">(</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">iterator</span> <span class="n">insert</span><span class="p">(</span><span class="k">const</span> <span class="n">iterator</span> <span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="n">value_type</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">begin</span><span class="p">();</span>
    <span class="n">insert</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>
  <span class="p">}</span>

<span class="nl">private:</span>
  <span class="n">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">i</span><span class="o">&gt;</span> <span class="n">class</span> <span class="n">Selector</span> <span class="p">{};</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">insertImplDiscr</span><span class="p">(</span><span class="n">iterator</span> <span class="n">p</span><span class="p">,</span>
                                  <span class="n">size_type</span> <span class="n">n</span><span class="p">,</span> <span class="n">value_type</span> <span class="n">c</span><span class="p">,</span> <span class="n">Selector</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Invariant</span> <span class="n">checker</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">);</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">checker</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">begin</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">capacity</span><span class="p">()</span> <span class="o">-</span> <span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const</span> <span class="n">size_type</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">begin</span><span class="p">();</span>
      <span class="n">reserve</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">sz</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">const</span> <span class="n">iterator</span> <span class="n">oldEnd</span> <span class="o">=</span> <span class="n">end</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">size_type</span><span class="p">(</span><span class="n">oldEnd</span> <span class="o">-</span> <span class="n">p</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">append</span><span class="p">(</span><span class="n">oldEnd</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span> <span class="n">oldEnd</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>Compatibility with std::string</p></td><td class="code"><div class="highlight"><pre>      <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_move</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;*</span><span class="n">oldEnd</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;*</span><span class="n">p</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
      <span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">append</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="p">(</span><span class="n">end</span><span class="p">()</span> <span class="o">-</span> <span class="n">p</span><span class="p">),</span> <span class="n">c</span><span class="p">);</span>
      <span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">oldEnd</span><span class="p">);</span>
      <span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">oldEnd</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">store_</span><span class="p">.</span><span class="n">writeTerminator</span><span class="p">();</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">template</span><span class="o">&lt;</span><span class="n">class</span> <span class="n">InputIter</span><span class="o">&gt;</span>
  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">insertImplDiscr</span><span class="p">(</span><span class="n">iterator</span> <span class="n">i</span><span class="p">,</span>
                                  <span class="n">InputIter</span> <span class="n">b</span><span class="p">,</span> <span class="n">InputIter</span> <span class="n">e</span><span class="p">,</span> <span class="n">Selector</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">insertImpl</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
               <span class="kr">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">iterator_traits</span><span class="o">&lt;</span><span class="n">InputIter</span><span class="o">&gt;::</span><span class="n">iterator_category</span><span class="p">());</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">FwdIterator</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">insertImpl</span><span class="p">(</span><span class="n">iterator</span> <span class="n">i</span><span class="p">,</span>
                  <span class="n">FwdIterator</span> <span class="n">s1</span><span class="p">,</span> <span class="n">FwdIterator</span> <span class="n">s2</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">forward_iterator_tag</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Invariant</span> <span class="n">checker</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">);</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">checker</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">begin</span><span class="p">();</span>
    <span class="k">const</span> <span class="kr">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">iterator_traits</span><span class="o">&lt;</span><span class="n">FwdIterator</span><span class="o">&gt;::</span><span class="n">difference_type</span> <span class="n">n2</span> <span class="o">=</span>
      <span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">n2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">using</span> <span class="n">namespace</span> <span class="n">fbstring_detail</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">());</span>

    <span class="k">const</span> <span class="kr">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">iterator_traits</span><span class="o">&lt;</span><span class="n">FwdIterator</span><span class="o">&gt;::</span><span class="n">difference_type</span> <span class="n">maxn2</span> <span class="o">=</span>
      <span class="n">capacity</span><span class="p">()</span> <span class="o">-</span> <span class="n">size</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">maxn2</span> <span class="o">&lt;</span> <span class="n">n2</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>Compatibility with std::string</p></td><td class="code"><div class="highlight"><pre>      <span class="n">reserve</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">n2</span><span class="p">);</span>
      <span class="n">i</span> <span class="o">=</span> <span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">n2</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">const</span> <span class="n">iterator</span> <span class="n">tailBegin</span> <span class="o">=</span> <span class="n">end</span><span class="p">()</span> <span class="o">-</span> <span class="n">n2</span><span class="p">;</span>
      <span class="n">store_</span><span class="p">.</span><span class="n">expand_noinit</span><span class="p">(</span><span class="n">n2</span><span class="p">);</span>
      <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span><span class="n">tailBegin</span><span class="p">,</span> <span class="n">tailBegin</span> <span class="o">+</span> <span class="n">n2</span><span class="p">,</span> <span class="n">end</span><span class="p">()</span> <span class="o">-</span> <span class="n">n2</span><span class="p">);</span>
      <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">reverse_iterator</span><span class="p">(</span><span class="n">tailBegin</span><span class="p">),</span> <span class="n">reverse_iterator</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                <span class="n">reverse_iterator</span><span class="p">(</span><span class="n">tailBegin</span> <span class="o">+</span> <span class="n">n2</span><span class="p">));</span>
      <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">FwdIterator</span> <span class="n">t</span> <span class="o">=</span> <span class="n">s1</span><span class="p">;</span>
      <span class="k">const</span> <span class="n">size_type</span> <span class="n">old_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">();</span>
      <span class="n">std</span><span class="o">::</span><span class="n">advance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">old_size</span> <span class="o">-</span> <span class="n">pos</span><span class="p">);</span>
      <span class="k">const</span> <span class="kt">size_t</span> <span class="n">newElems</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">s2</span><span class="p">);</span>
      <span class="n">store_</span><span class="p">.</span><span class="n">expand_noinit</span><span class="p">(</span><span class="n">n2</span><span class="p">);</span>
      <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">old_size</span><span class="p">);</span>
      <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">old_size</span><span class="p">,</span>
                                 <span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">old_size</span> <span class="o">+</span> <span class="n">newElems</span><span class="p">);</span>
      <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">store_</span><span class="p">.</span><span class="n">writeTerminator</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">InputIterator</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">insertImpl</span><span class="p">(</span><span class="n">iterator</span> <span class="n">i</span><span class="p">,</span>
                  <span class="n">InputIterator</span> <span class="n">b</span><span class="p">,</span> <span class="n">InputIterator</span> <span class="n">e</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">input_iterator_tag</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">basic_fbstring</span> <span class="n">temp</span><span class="p">(</span><span class="n">begin</span><span class="p">(),</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">b</span> <span class="o">!=</span> <span class="n">e</span><span class="p">;</span> <span class="o">++</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">temp</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">temp</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="p">());</span>
    <span class="n">swap</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
  <span class="p">}</span>

<span class="nl">public:</span>
  <span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">ItOrLength</span><span class="p">,</span> <span class="n">class</span> <span class="n">ItOrChar</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">insert</span><span class="p">(</span><span class="n">iterator</span> <span class="n">p</span><span class="p">,</span> <span class="n">ItOrLength</span> <span class="n">first_or_n</span><span class="p">,</span> <span class="n">ItOrChar</span> <span class="n">last_or_c</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Selector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">ItOrLength</span><span class="o">&gt;::</span><span class="n">is_specialized</span><span class="o">&gt;</span> <span class="n">sel</span><span class="p">;</span>
    <span class="n">insertImplDiscr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">first_or_n</span><span class="p">,</span> <span class="n">last_or_c</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">erase</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n</span> <span class="o">=</span> <span class="n">npos</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Invariant</span> <span class="n">checker</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">);</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">checker</span><span class="p">;</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">length</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">procrustes</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">length</span><span class="p">()</span> <span class="o">-</span> <span class="n">pos</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">end</span><span class="p">(),</span> <span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
    <span class="n">resize</span><span class="p">(</span><span class="n">length</span><span class="p">()</span> <span class="o">-</span> <span class="n">n</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">iterator</span> <span class="n">erase</span><span class="p">(</span><span class="n">iterator</span> <span class="n">position</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">size_type</span> <span class="n">pos</span><span class="p">(</span><span class="n">position</span> <span class="o">-</span> <span class="n">begin</span><span class="p">());</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">erase</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">iterator</span> <span class="n">erase</span><span class="p">(</span><span class="n">iterator</span> <span class="n">first</span><span class="p">,</span> <span class="n">iterator</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">size_type</span> <span class="n">pos</span><span class="p">(</span><span class="n">first</span> <span class="o">-</span> <span class="n">begin</span><span class="p">());</span>
    <span class="n">erase</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">last</span> <span class="o">-</span> <span class="n">first</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>A lot of code in fbcode still uses this method, so keep it here for now.</p></td><td class="code"><div class="highlight"><pre>  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">replace</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n1</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>21.3.2 iterators:</p></td><td class="code"><div class="highlight"><pre>  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">replace</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n1</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">,</span>
                          <span class="n">size_type</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">pos2</span> <span class="o">&lt;=</span> <span class="n">str</span><span class="p">.</span><span class="n">length</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos2</span><span class="p">,</span>
                   <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">pos2</span><span class="p">));</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>Non-standard functions. They intentionally return by value to
reduce pressure on the reference counting mechanism.</p></td><td class="code"><div class="highlight"><pre>  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">replace</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n1</span><span class="p">,</span> <span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>21.3.3 capacity:</p></td><td class="code"><div class="highlight"><pre>  <span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">StrOrLength</span><span class="p">,</span> <span class="n">class</span> <span class="n">NumOrChar</span><span class="o">&gt;</span>
  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">replace</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n1</span><span class="p">,</span>
                          <span class="n">StrOrLength</span> <span class="n">s_or_n2</span><span class="p">,</span> <span class="n">NumOrChar</span> <span class="n">n_or_c</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Invariant</span> <span class="n">checker</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">);</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">checker</span><span class="p">;</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">procrustes</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">length</span><span class="p">()</span> <span class="o">-</span> <span class="n">pos</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">iterator</span> <span class="n">b</span> <span class="o">=</span> <span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span> <span class="o">+</span> <span class="n">n1</span><span class="p">,</span> <span class="n">s_or_n2</span><span class="p">,</span> <span class="n">n_or_c</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">replace</span><span class="p">(</span><span class="n">iterator</span> <span class="n">i1</span><span class="p">,</span> <span class="n">iterator</span> <span class="n">i2</span><span class="p">,</span> <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">replace</span><span class="p">(</span><span class="n">iterator</span> <span class="n">i1</span><span class="p">,</span> <span class="n">iterator</span> <span class="n">i2</span><span class="p">,</span> <span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="p">}</span>

<span class="nl">private:</span>
  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">replaceImplDiscr</span><span class="p">(</span><span class="n">iterator</span> <span class="n">i1</span><span class="p">,</span> <span class="n">iterator</span> <span class="n">i2</span><span class="p">,</span>
                                   <span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n</span><span class="p">,</span>
                                   <span class="n">Selector</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">i1</span> <span class="o">&lt;=</span> <span class="n">i2</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">begin</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">i1</span> <span class="o">&amp;&amp;</span> <span class="n">i1</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">());</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">begin</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">i2</span> <span class="o">&amp;&amp;</span> <span class="n">i2</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">replaceImplDiscr</span><span class="p">(</span><span class="n">iterator</span> <span class="n">i1</span><span class="p">,</span> <span class="n">iterator</span> <span class="n">i2</span><span class="p">,</span>
                                   <span class="n">size_type</span> <span class="n">n2</span><span class="p">,</span> <span class="n">value_type</span> <span class="n">c</span><span class="p">,</span> <span class="n">Selector</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">size_type</span> <span class="n">n1</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">-</span> <span class="n">i1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n1</span> <span class="o">&gt;</span> <span class="n">n2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
      <span class="n">erase</span><span class="p">(</span><span class="n">i1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">,</span> <span class="n">i2</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
      <span class="n">insert</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">n2</span> <span class="o">-</span> <span class="n">n1</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">isSane</span><span class="p">());</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">InputIter</span><span class="o">&gt;</span>
  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">replaceImplDiscr</span><span class="p">(</span><span class="n">iterator</span> <span class="n">i1</span><span class="p">,</span> <span class="n">iterator</span> <span class="n">i2</span><span class="p">,</span>
                                   <span class="n">InputIter</span> <span class="n">b</span><span class="p">,</span> <span class="n">InputIter</span> <span class="n">e</span><span class="p">,</span>
                                   <span class="n">Selector</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">replaceImpl</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
                <span class="kr">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">iterator_traits</span><span class="o">&lt;</span><span class="n">InputIter</span><span class="o">&gt;::</span><span class="n">iterator_category</span><span class="p">());</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
  <span class="p">}</span>

<span class="nl">private:</span>
  <span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">FwdIterator</span><span class="p">,</span> <span class="n">class</span> <span class="n">P</span><span class="o">&gt;</span>
  <span class="n">bool</span> <span class="n">replaceAliased</span><span class="p">(</span><span class="n">iterator</span> <span class="n">i1</span><span class="p">,</span> <span class="n">iterator</span> <span class="n">i2</span><span class="p">,</span>
                      <span class="n">FwdIterator</span> <span class="n">s1</span><span class="p">,</span> <span class="n">FwdIterator</span> <span class="n">s2</span><span class="p">,</span> <span class="n">P</span><span class="o">*</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">FwdIterator</span><span class="o">&gt;</span>
  <span class="n">bool</span> <span class="n">replaceAliased</span><span class="p">(</span><span class="n">iterator</span> <span class="n">i1</span><span class="p">,</span> <span class="n">iterator</span> <span class="n">i2</span><span class="p">,</span>
                      <span class="n">FwdIterator</span> <span class="n">s1</span><span class="p">,</span> <span class="n">FwdIterator</span> <span class="n">s2</span><span class="p">,</span> <span class="n">value_type</span><span class="o">*</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">less_equal</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*&gt;</span> <span class="n">le</span> <span class="o">=</span>
      <span class="n">std</span><span class="o">::</span><span class="n">less_equal</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*&gt;</span><span class="p">();</span>
    <span class="k">const</span> <span class="n">bool</span> <span class="n">aliased</span> <span class="o">=</span> <span class="n">le</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">begin</span><span class="p">(),</span> <span class="o">&amp;*</span><span class="n">s1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">le</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">s1</span><span class="p">,</span> <span class="o">&amp;*</span><span class="n">end</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aliased</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>Do this in two steps to minimize slack memory copied (see
smartRealloc).</p></td><td class="code"><div class="highlight"><pre>    <span class="n">basic_fbstring</span> <span class="n">temp</span><span class="p">;</span>
    <span class="n">temp</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">i2</span> <span class="o">-</span> <span class="n">i1</span><span class="p">)</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">));</span>
    <span class="n">temp</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">begin</span><span class="p">(),</span> <span class="n">i1</span><span class="p">).</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">).</span><span class="n">append</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">end</span><span class="p">());</span>
    <span class="n">swap</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

<span class="nl">public:</span>
  <span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">FwdIterator</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">replaceImpl</span><span class="p">(</span><span class="n">iterator</span> <span class="n">i1</span><span class="p">,</span> <span class="n">iterator</span> <span class="n">i2</span><span class="p">,</span>
                   <span class="n">FwdIterator</span> <span class="n">s1</span><span class="p">,</span> <span class="n">FwdIterator</span> <span class="n">s2</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">forward_iterator_tag</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Invariant</span> <span class="n">checker</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">);</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">checker</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><p>21.3.4 element access:</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">replaceAliased</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="o">&amp;*</span><span class="n">s1</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">auto</span> <span class="k">const</span> <span class="n">n1</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">-</span> <span class="n">i1</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">n1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">auto</span> <span class="k">const</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">n2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n1</span> <span class="o">&gt;</span> <span class="n">n2</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-96"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-96">&#182;</a></div><p>Just call c_str() to make sure '\0' is present</p></td><td class="code"><div class="highlight"><pre>      <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">i1</span><span class="p">);</span>
      <span class="n">erase</span><span class="p">(</span><span class="n">i1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">,</span> <span class="n">i2</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-97"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-97">&#182;</a></div><p>21.3.5 modifiers:</p></td><td class="code"><div class="highlight"><pre>      <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">copy_n</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">i1</span><span class="p">);</span>
      <span class="n">std</span><span class="o">::</span><span class="n">advance</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">n1</span><span class="p">);</span>
      <span class="n">insert</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">isSane</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">InputIterator</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">replaceImpl</span><span class="p">(</span><span class="n">iterator</span> <span class="n">i1</span><span class="p">,</span> <span class="n">iterator</span> <span class="n">i2</span><span class="p">,</span>
                   <span class="n">InputIterator</span> <span class="n">b</span><span class="p">,</span> <span class="n">InputIterator</span> <span class="n">e</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">input_iterator_tag</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">basic_fbstring</span> <span class="n">temp</span><span class="p">(</span><span class="n">begin</span><span class="p">(),</span> <span class="n">i1</span><span class="p">);</span>
    <span class="n">temp</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">e</span><span class="p">).</span><span class="n">append</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">end</span><span class="p">());</span>
    <span class="n">swap</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
  <span class="p">}</span>

<span class="nl">public:</span>
  <span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">T1</span><span class="p">,</span> <span class="n">class</span> <span class="n">T2</span><span class="o">&gt;</span>
  <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">replace</span><span class="p">(</span><span class="n">iterator</span> <span class="n">i1</span><span class="p">,</span> <span class="n">iterator</span> <span class="n">i2</span><span class="p">,</span>
                          <span class="n">T1</span> <span class="n">first_or_n_or_s</span><span class="p">,</span> <span class="n">T2</span> <span class="n">last_or_c_or_n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">bool</span>
      <span class="n">num1</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T1</span><span class="o">&gt;::</span><span class="n">is_specialized</span><span class="p">,</span>
      <span class="n">num2</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T2</span><span class="o">&gt;::</span><span class="n">is_specialized</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">replaceImplDiscr</span><span class="p">(</span>
      <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">first_or_n_or_s</span><span class="p">,</span> <span class="n">last_or_c_or_n</span><span class="p">,</span>
      <span class="n">Selector</span><span class="o">&lt;</span><span class="n">num1</span> <span class="o">?</span> <span class="p">(</span><span class="n">num2</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">num2</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span><span class="o">&gt;</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">copy</span><span class="p">(</span><span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">procrustes</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">pos</span><span class="p">);</span>

    <span class="n">fbstring_detail</span><span class="o">::</span><span class="n">pod_copy</span><span class="p">(</span>
      <span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span>
      <span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span>
      <span class="n">s</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">store_</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">store_</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-98"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-98">&#182;</a></div><p>Restore the source</p></td><td class="code"><div class="highlight"><pre>  <span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">c_str</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">store_</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">data</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">c_str</span><span class="p">();</span> <span class="p">}</span>

  <span class="n">allocator_type</span> <span class="n">get_allocator</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">allocator_type</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pos</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">needle</span><span class="p">,</span> <span class="k">const</span> <span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span>
                 <span class="k">const</span> <span class="n">size_type</span> <span class="n">nsize</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nsize</span><span class="p">)</span> <span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
    <span class="k">auto</span> <span class="k">const</span> <span class="n">size</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nsize</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="k">return</span> <span class="n">npos</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-99"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-99">&#182;</a></div><p>std::copy(
   reverse<em>iterator(oldEnd - n),
   reverse</em>iterator(p),
   reverse_iterator(oldEnd));</p></td><td class="code"><div class="highlight"><pre>    <span class="k">auto</span> <span class="k">const</span> <span class="n">haystack</span> <span class="o">=</span> <span class="n">data</span><span class="p">();</span>
    <span class="k">auto</span> <span class="k">const</span> <span class="n">nsize_1</span> <span class="o">=</span> <span class="n">nsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">auto</span> <span class="k">const</span> <span class="n">lastNeedle</span> <span class="o">=</span> <span class="n">needle</span><span class="p">[</span><span class="n">nsize_1</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-100"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-100">&#182;</a></div><p>realloc the string</p></td><td class="code"><div class="highlight"><pre>    <span class="n">size_type</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">const</span> <span class="n">E</span> <span class="o">*</span> <span class="n">i</span> <span class="o">=</span> <span class="n">haystack</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">iEnd</span> <span class="o">=</span> <span class="n">haystack</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="n">nsize_1</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">iEnd</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-101"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-101">&#182;</a></div><p>Replaces at most n1 chars of *this, starting with pos1 with the
content of str</p></td><td class="code"><div class="highlight"><pre>      <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">nsize_1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lastNeedle</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">iEnd</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-102"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-102">&#182;</a></div><p>Replaces at most n1 chars of *this, starting with pos1,
with at most n2 chars of str starting with pos2</p></td><td class="code"><div class="highlight"><pre>          <span class="k">return</span> <span class="n">npos</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr>


<tr id="section-103"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-103">&#182;</a></div><p>Replaces at most n1 chars of *this, starting with pos, with chars from s</p></td><td class="code"><div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">nsize</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">needle</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-104"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-104">&#182;</a></div><p>Replaces at most n1 chars of *this, starting with pos, with n2
occurrences of c</p>

<p>consolidated with</p>

<p>Replaces at most n1 chars of *this, starting with pos, with at
most n2 chars of str.  str must have at least n2 chars.</p></td><td class="code"><div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="n">skip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">skip</span> <span class="o">&lt;=</span> <span class="n">nsize_1</span> <span class="o">&amp;&amp;</span> <span class="n">needle</span><span class="p">[</span><span class="n">nsize_1</span> <span class="o">-</span> <span class="n">skip</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lastNeedle</span><span class="p">)</span> <span class="p">{</span>
              <span class="o">++</span><span class="n">skip</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="n">skip</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-105"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-105">&#182;</a></div><p>Aliased replace, copy to new string</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">j</span> <span class="o">==</span> <span class="n">nsize</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-106"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-106">&#182;</a></div><p>Handle aliased replace</p></td><td class="code"><div class="highlight"><pre>          <span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="n">haystack</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">npos</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find</span> <span class="p">(</span><span class="n">value_type</span> <span class="n">c</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">rfind</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">npos</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">rfind</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pos</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">rfind</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">())</span> <span class="k">return</span> <span class="n">npos</span><span class="p">;</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">length</span><span class="p">()</span> <span class="o">-</span> <span class="n">n</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">pos</span><span class="p">;</span>

    <span class="n">const_iterator</span> <span class="n">i</span><span class="p">(</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">traits_type</span><span class="o">::</span><span class="n">eq</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
          <span class="o">&amp;&amp;</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">compare</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="n">begin</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">begin</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">npos</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">rfind</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">npos</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">rfind</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">rfind</span><span class="p">(</span><span class="n">value_type</span> <span class="n">c</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">npos</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">rfind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_first_of</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find_first_of</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pos</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_first_of</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span>
                          <span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">()</span> <span class="o">||</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">npos</span><span class="p">;</span>
    <span class="n">const_iterator</span> <span class="n">i</span><span class="p">(</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">),</span>
      <span class="n">finish</span><span class="p">(</span><span class="n">end</span><span class="p">());</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">finish</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">traits_type</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="n">begin</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">npos</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_first_of</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find_first_of</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_first_of</span><span class="p">(</span><span class="n">value_type</span> <span class="n">c</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find_first_of</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_last_of</span> <span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">,</span>
                          <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">npos</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find_last_of</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pos</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_last_of</span> <span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span>
                          <span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pos</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">const_iterator</span> <span class="n">i</span><span class="p">(</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(;;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">traits_type</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="n">begin</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">begin</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">npos</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_last_of</span> <span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span>
                          <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">npos</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find_last_of</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_last_of</span> <span class="p">(</span><span class="n">value_type</span> <span class="n">c</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">npos</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find_last_of</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_first_not_of</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">,</span>
                              <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find_first_not_of</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pos</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_first_not_of</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span>
                              <span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">const_iterator</span>
        <span class="n">i</span><span class="p">(</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">),</span>
        <span class="n">finish</span><span class="p">(</span><span class="n">end</span><span class="p">());</span>
      <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">finish</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">traits_type</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="n">begin</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">npos</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_first_not_of</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span>
                              <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find_first_not_of</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_first_not_of</span><span class="p">(</span><span class="n">value_type</span> <span class="n">c</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find_first_not_of</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_last_not_of</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">,</span>
                             <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">npos</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find_last_not_of</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pos</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_last_not_of</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span><span class="p">,</span>
                             <span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">pos</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">const_iterator</span> <span class="n">i</span><span class="p">(</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(;;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">traits_type</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="n">begin</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">begin</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">npos</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_last_not_of</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span>
                             <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">npos</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find_last_not_of</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">size_type</span> <span class="n">find_last_not_of</span> <span class="p">(</span><span class="n">value_type</span> <span class="n">c</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">npos</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">find_last_not_of</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">basic_fbstring</span> <span class="n">substr</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n</span> <span class="o">=</span> <span class="n">npos</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">basic_fbstring</span><span class="p">(</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">pos</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">compare</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-107"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-107">&#182;</a></div><p>shrinks</p></td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="n">compare</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">(),</span> <span class="n">str</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">compare</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n1</span><span class="p">,</span>
              <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">compare</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">compare</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n1</span><span class="p">,</span>
              <span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">compare</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">compare</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n1</span><span class="p">,</span>
              <span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n2</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">pos1</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">procrustes</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">pos1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-108"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-108">&#182;</a></div><p>grows</p></td><td class="code"><div class="highlight"><pre>    <span class="k">const</span> <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">compare</span><span class="p">(</span><span class="n">pos1</span> <span class="o">+</span> <span class="n">data</span><span class="p">(),</span> <span class="n">s</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="n">n1</span> <span class="o">&gt;</span> <span class="n">n2</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">n1</span> <span class="o">&lt;</span> <span class="n">n2</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">compare</span><span class="p">(</span><span class="n">size_type</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n1</span><span class="p">,</span>
              <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">,</span>
              <span class="n">size_type</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">n2</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">enforce</span><span class="p">(</span><span class="n">pos2</span> <span class="o">&lt;=</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">__throw_out_of_range</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">compare</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">pos2</span><span class="p">,</span>
                   <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">pos2</span><span class="p">));</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-109"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-109">&#182;</a></div><p>21.3.6 string operations:</p></td><td class="code"><div class="highlight"><pre>  <span class="kt">int</span> <span class="n">compare</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-110"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-110">&#182;</a></div><p>Don't use std::search, use a Boyer-Moore-like trick by comparing
the last characters first</p></td><td class="code"><div class="highlight"><pre>    <span class="k">const</span> <span class="n">size_type</span> <span class="n">n1</span><span class="p">(</span><span class="n">size</span><span class="p">()),</span> <span class="n">n2</span><span class="p">(</span><span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">compare</span><span class="p">(</span><span class="n">data</span><span class="p">(),</span> <span class="n">s</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="n">n1</span> <span class="o">&gt;</span> <span class="n">n2</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">n1</span> <span class="o">&lt;</span> <span class="n">n2</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

<span class="nl">private:</span></pre></div></td></tr>


<tr id="section-111"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-111">&#182;</a></div><p>Boyer-Moore skip value for the last char in the needle. Zero is
not a valid value; skip will be computed the first time it's
needed.</p></td><td class="code"><div class="highlight"><pre>  <span class="n">Storage</span> <span class="n">store_</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-112"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-112">&#182;</a></div><p>Boyer-Moore: match the last element in the needle</p></td><td class="code"><div class="highlight"><pre><span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>
  <span class="n">result</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">lhs</span><span class="p">).</span><span class="n">append</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-113"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-113">&#182;</a></div><p>not found</p></td><td class="code"><div class="highlight"><pre><span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">operator</span><span class="o">+</span><span class="p">(</span><span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">rhs</span><span class="p">));</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-114"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-114">&#182;</a></div><p>Here we know that the last char matches
Continue in pedestrian mode</p></td><td class="code"><div class="highlight"><pre><span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                                     <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">lhs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-115"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-115">&#182;</a></div><p>Not found, we can skip
Compute the skip value lazily</p></td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lhs</span><span class="p">));</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-116"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-116">&#182;</a></div><p>Check if done searching</p></td><td class="code"><div class="highlight"><pre>  <span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">rhsC</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">lhs</span> <span class="o">+</span> <span class="n">rhsC</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-117"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-117">&#182;</a></div><p>Yay</p></td><td class="code"><div class="highlight"><pre><span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">operator</span><span class="o">+</span><span class="p">(</span><span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                                     <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">rhs</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">operator</span><span class="o">+</span><span class="p">(</span>
  <span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">lhs</span><span class="p">,</span>
  <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-118"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-118">&#182;</a></div><p>FIX due to Goncalo N M de Carvalho July 18, 2005</p></td><td class="code"><div class="highlight"><pre>  <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>
  <span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">size_type</span> <span class="n">len</span> <span class="o">=</span>
    <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">lhs</span><span class="p">);</span>
  <span class="n">result</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">len</span><span class="p">).</span><span class="n">append</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">operator</span><span class="o">+</span><span class="p">(</span>
  <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span> <span class="n">lhs</span><span class="p">,</span>
  <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>
  <span class="n">result</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">result</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">lhs</span><span class="p">);</span>
  <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">operator</span><span class="o">+</span><span class="p">(</span>
  <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
  <span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">typedef</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">size_type</span> <span class="n">size_type</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">traits_type</span> <span class="n">traits_type</span><span class="p">;</span>

  <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">size_type</span> <span class="n">len</span> <span class="o">=</span> <span class="n">traits_type</span><span class="o">::</span><span class="n">length</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span>
  <span class="n">result</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">lhs</span><span class="p">).</span><span class="n">append</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">operator</span><span class="o">+</span><span class="p">(</span>
  <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
  <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>
  <span class="n">result</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">lhs</span><span class="p">);</span>
  <span class="n">result</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">lhs</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">rhs</span> <span class="o">==</span> <span class="n">lhs</span><span class="p">;</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">lhs</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">lhs</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">);</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">lhs</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">);</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">lhs</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">);</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
               <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">lhs</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
               <span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">lhs</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">lhs</span><span class="p">,</span>
               <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">rhs</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
               <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">rhs</span> <span class="o">&lt;</span> <span class="n">lhs</span><span class="p">;</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
               <span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">rhs</span> <span class="o">&lt;</span> <span class="n">lhs</span><span class="p">;</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">lhs</span><span class="p">,</span>
               <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">rhs</span> <span class="o">&lt;</span> <span class="n">lhs</span><span class="p">;</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">&lt;=</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">rhs</span> <span class="o">&lt;</span> <span class="n">lhs</span><span class="p">);</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">&lt;=</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">rhs</span> <span class="o">&lt;</span> <span class="n">lhs</span><span class="p">);</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">&lt;=</span><span class="p">(</span><span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">rhs</span> <span class="o">&lt;</span> <span class="n">lhs</span><span class="p">);</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">&gt;=</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">lhs</span> <span class="o">&lt;</span> <span class="n">rhs</span><span class="p">);</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">&gt;=</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">lhs</span> <span class="o">&lt;</span> <span class="n">rhs</span><span class="p">);</span> <span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">&gt;=</span><span class="p">(</span><span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">*</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">lhs</span> <span class="o">&lt;</span> <span class="n">rhs</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-119"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-119">&#182;</a></div><p>The line below fixed by Jean-Francois Bastien, 04-23-2007. Thanks!</p></td><td class="code"><div class="highlight"><pre><span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">lhs</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-120"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-120">&#182;</a></div><p>Code from Jean-Francois Bastien (03/26/2007)</p></td><td class="code"><div class="highlight"><pre><span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">std</span><span class="o">::</span><span class="n">basic_istream</span><span class="o">&lt;</span>
  <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="p">,</span>
  <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">traits_type</span><span class="o">&gt;&amp;</span>
  <span class="n">operator</span><span class="o">&gt;&gt;</span><span class="p">(</span>
    <span class="n">std</span><span class="o">::</span><span class="n">basic_istream</span><span class="o">&lt;</span><span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="p">,</span>
    <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">traits_type</span><span class="o">&gt;&amp;</span> <span class="n">is</span><span class="p">,</span>
    <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">basic_istream</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;::</span><span class="n">sentry</span> <span class="n">sentry</span><span class="p">(</span><span class="n">is</span><span class="p">);</span>
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">basic_istream</span><span class="o">&lt;</span><span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="p">,</span>
                             <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">traits_type</span><span class="o">&gt;</span>
                        <span class="n">__istream_type</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="kr">typename</span> <span class="n">__istream_type</span><span class="o">::</span><span class="n">ios_base</span> <span class="n">__ios_base</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">extracted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">err</span> <span class="o">=</span> <span class="n">__ios_base</span><span class="o">::</span><span class="n">goodbit</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sentry</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">n</span> <span class="o">=</span> <span class="n">is</span><span class="p">.</span><span class="n">width</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">n</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">max_size</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">str</span><span class="p">.</span><span class="n">erase</span><span class="p">();</span>
    <span class="k">auto</span> <span class="n">got</span> <span class="o">=</span> <span class="n">is</span><span class="p">.</span><span class="n">rdbuf</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sgetc</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">extracted</span> <span class="o">!=</span> <span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="n">got</span> <span class="o">!=</span> <span class="n">T</span><span class="o">::</span><span class="n">eof</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="n">got</span><span class="p">);</span> <span class="o">++</span><span class="n">extracted</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-121"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-121">&#182;</a></div><p>Could forward to compare(0, size(), s, traits_type::length(s))
but that does two extra checks</p></td><td class="code"><div class="highlight"><pre>      <span class="n">str</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">got</span><span class="p">);</span>
      <span class="n">got</span> <span class="o">=</span> <span class="n">is</span><span class="p">.</span><span class="n">rdbuf</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">snextc</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">==</span> <span class="n">T</span><span class="o">::</span><span class="n">eof</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">err</span> <span class="o">|=</span> <span class="n">__ios_base</span><span class="o">::</span><span class="n">eofbit</span><span class="p">;</span>
      <span class="n">is</span><span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">extracted</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">err</span> <span class="o">|=</span> <span class="n">__ios_base</span><span class="o">::</span><span class="n">failbit</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">is</span><span class="p">.</span><span class="n">setstate</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">is</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">std</span><span class="o">::</span><span class="n">basic_ostream</span><span class="o">&lt;</span><span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="p">,</span>
                   <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">traits_type</span><span class="o">&gt;&amp;</span>
<span class="n">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span>
  <span class="n">std</span><span class="o">::</span><span class="n">basic_ostream</span><span class="o">&lt;</span><span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="p">,</span>
  <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">traits_type</span><span class="o">&gt;&amp;</span> <span class="n">os</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">os</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="k">return</span> <span class="n">os</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef _LIBSTDCXX_FBSTRING</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">std</span><span class="o">::</span><span class="n">basic_istream</span><span class="o">&lt;</span><span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="p">,</span>
                   <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">traits_type</span><span class="o">&gt;&amp;</span>
<span class="n">getline</span><span class="p">(</span>
  <span class="n">std</span><span class="o">::</span><span class="n">basic_istream</span><span class="o">&lt;</span><span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="p">,</span>
  <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">traits_type</span><span class="o">&gt;&amp;</span> <span class="n">is</span><span class="p">,</span>
    <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">str</span><span class="p">,</span>
  <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span> <span class="n">delim</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-122"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-122">&#182;</a></div><p>Data</p></td><td class="code"><div class="highlight"><pre>  <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-123"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-123">&#182;</a></div><p>non-member functions
C++11 21.4.8.1/2</p></td><td class="code"><div class="highlight"><pre>    <span class="k">auto</span> <span class="k">const</span> <span class="n">newSize</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">checkedRealloc</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">newSize</span><span class="p">));</span>
    <span class="n">is</span><span class="p">.</span><span class="n">getline</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">newSize</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span> <span class="n">delim</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="p">.</span><span class="n">bad</span><span class="p">()</span> <span class="o">||</span> <span class="n">is</span><span class="p">.</span><span class="n">eof</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">is</span><span class="p">.</span><span class="n">fail</span><span class="p">())</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-124"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-124">&#182;</a></div><p>C++11 21.4.8.1/2</p></td><td class="code"><div class="highlight"><pre>      <span class="n">size</span> <span class="o">+=</span> <span class="n">std</span><span class="o">::</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-125"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-125">&#182;</a></div><p>C++11 21.4.8.1/3</p></td><td class="code"><div class="highlight"><pre>    <span class="n">size</span> <span class="o">=</span> <span class="n">newSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-126"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-126">&#182;</a></div><p>Good, at least we don't need to reallocate</p></td><td class="code"><div class="highlight"><pre>    <span class="n">is</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">AcquireMallocatedString</span><span class="p">());</span>
  <span class="n">result</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">is</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">std</span><span class="o">::</span><span class="n">basic_istream</span><span class="o">&lt;</span><span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="p">,</span>
                   <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">traits_type</span><span class="o">&gt;&amp;</span>
<span class="n">getline</span><span class="p">(</span>
  <span class="n">std</span><span class="o">::</span><span class="n">basic_istream</span><span class="o">&lt;</span><span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="p">,</span>
  <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">traits_type</span><span class="o">&gt;&amp;</span> <span class="n">is</span><span class="p">,</span>
  <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-127"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-127">&#182;</a></div><p>Meh, no go. Forward to operator+(const&amp;, const&amp;).</p></td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="n">getline</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E1</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="k">const</span> <span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E1</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">size_type</span>
<span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E1</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">npos</span> <span class="o">=</span>
              <span class="n">static_cast</span><span class="o">&lt;</span><span class="kr">typename</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E1</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;::</span><span class="n">size_type</span><span class="o">&gt;</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifndef _LIBSTDCXX_FBSTRING</span></pre></div></td></tr>


<tr id="section-128"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-128">&#182;</a></div><p>C++11 21.4.8.1/4</p></td><td class="code"><div class="highlight"><pre><span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">lhs</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lhs</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">rhs</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">rhs</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">rhs</span> <span class="o">==</span> <span class="n">lhs</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">lhs</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="kr">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="n">bool</span> <span class="n">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">lhs</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">lhs</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if !defined(_LIBSTDCXX_FBSTRING)</span>
<span class="k">typedef</span> <span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">fbstring</span><span class="p">;</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-129"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-129">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="n">template</span> <span class="o">&lt;</span><span class="n">class</span> <span class="n">T</span><span class="p">,</span> <span class="n">class</span> <span class="n">R</span><span class="p">,</span> <span class="n">class</span> <span class="n">A</span><span class="p">,</span> <span class="n">class</span> <span class="n">S</span><span class="o">&gt;</span>
<span class="n">FOLLY_ASSUME_RELOCATABLE</span><span class="p">(</span><span class="n">basic_fbstring</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="o">&gt;</span><span class="p">);</span>

<span class="cp">#else</span>
<span class="n">_GLIBCXX_END_NAMESPACE_VERSION</span>
<span class="cp">#endif</span>

<span class="p">}</span> <span class="c1">// namespace folly</span>

<span class="cp">#ifndef _LIBSTDCXX_FBSTRING</span>

<span class="n">namespace</span> <span class="n">std</span> <span class="p">{</span>
<span class="n">template</span> <span class="o">&lt;&gt;</span>
<span class="k">struct</span> <span class="n">hash</span><span class="o">&lt;</span> <span class="o">::</span><span class="n">folly</span><span class="o">::</span><span class="n">fbstring</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">operator</span><span class="p">()(</span><span class="k">const</span> <span class="o">::</span><span class="n">folly</span><span class="o">::</span><span class="n">fbstring</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">::</span><span class="n">folly</span><span class="o">::</span><span class="n">hash</span><span class="o">::</span><span class="n">fnv32</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="c1">// _LIBSTDCXX_FBSTRING</span>

<span class="cp">#endif </span><span class="c1">// FOLLY_BASE_FBSTRING_H_</span>

</pre></div></td></tr>


<tr id="section-130"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-130">&#182;</a></div><p>subclause 21.3.7.8:</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-131"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-131">&#182;</a></div><p>TODO: make this faster.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-132"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-132">&#182;</a></div><p>Whew. We get to store this guy</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-133"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-133">&#182;</a></div><p>Use the nonstandard getdelim()</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-134"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-134">&#182;</a></div><p>This looks quadratic but it really depends on realloc</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-135"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-135">&#182;</a></div><p>done by either failure, end of file, or normal read</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-136"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-136">&#182;</a></div><p>Here we have failed due to too short a buffer
Minus one to discount the terminating '\0'</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-137"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-137">&#182;</a></div><p>Clear the error so we can continue reading</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-138"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-138">&#182;</a></div><p>Just forward to the version with a delimiter</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-139"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-139">&#182;</a></div><p>basic_string compatibility routines</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-140"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-140">&#182;</a></div><p>fbstring is relocatable</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/folly",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
