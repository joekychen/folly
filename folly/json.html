<!DOCTYPE html>
<html><head><title>joekychen/folly » folly › json.cpp

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>json.cpp</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2012 Facebook, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="cm"> * you may not use this file except in compliance with the License.</span>
<span class="cm"> * You may obtain a copy of the License at</span>
<span class="cm"> *</span>
<span class="cm"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="cm"> *</span>
<span class="cm"> * Unless required by applicable law or agreed to in writing, software</span>
<span class="cm"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="cm"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="cm"> * See the License for the specific language governing permissions and</span>
<span class="cm"> * limitations under the License.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;folly/json.h&quot;</span>
<span class="cp">#include &lt;cassert&gt;</span>
<span class="cp">#include &lt;boost/next_prior.hpp&gt;</span>
<span class="cp">#include &lt;boost/algorithm/string.hpp&gt;</span>

<span class="cp">#include &quot;folly/Range.h&quot;</span>
<span class="cp">#include &quot;folly/Unicode.h&quot;</span>
<span class="cp">#include &quot;folly/Conv.h&quot;</span>

<span class="k">namespace</span> <span class="n">folly</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>////////////////////////////////////////////////////////////////////</p></td><td class="code"><div class="highlight"><pre><span class="k">namespace</span> <span class="n">json</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="p">{</span>

<span class="n">char32_t</span> <span class="n">decodeUtf8</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&amp;</span> <span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* The following encodings are valid, except for the 5 and 6 byte</span>
<span class="cm">   * combinations:</span>
<span class="cm">   * 0xxxxxxx</span>
<span class="cm">   * 110xxxxx 10xxxxxx</span>
<span class="cm">   * 1110xxxx 10xxxxxx 10xxxxxx</span>
<span class="cm">   * 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</span>
<span class="cm">   * 111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx</span>
<span class="cm">   * 1111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx</span>
<span class="cm">   */</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;folly::decodeUtf8 empty/invalid string&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fst</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fst</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>trivial case</p></td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">static</span> <span class="k">const</span> <span class="n">uint32_t</span> <span class="n">bitMask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>upper control bits are masked out later</p></td><td class="code"><div class="highlight"><pre>  <span class="n">uint32_t</span> <span class="n">d</span> <span class="o">=</span> <span class="n">fst</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">fst</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span>
      <span class="n">to</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;folly::decodeUtf8 i=0 d=&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">fst</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span>
        <span class="n">to</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;folly::decodeUtf8 i=&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot; tmp=&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span><span class="n">tmp</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
    <span class="n">fst</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fst</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">d</span> <span class="o">&amp;=</span> <span class="n">bitMask</span><span class="p">[</span><span class="n">i</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>overlong, could have been encoded with i bytes</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">((</span><span class="n">d</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bitMask</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span>
          <span class="n">to</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;folly::decodeUtf8 i=&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot; d=&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">));</span>
      <span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>check for surrogates only needed for 3 bytes</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">d</span> <span class="o">&gt;=</span> <span class="mh">0xD800</span> <span class="o">&amp;&amp;</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="mh">0xDFFF</span><span class="p">)</span> <span class="o">||</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="mh">0x10FFFF</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span>
            <span class="n">to</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;folly::decodeUtf8 i=&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot; d=&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="n">p</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">d</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;folly::decodeUtf8 encoding length maxed out&quot;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Escape a string so that it is legal to print it in JSON text.</p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="n">escapeString</span><span class="p">(</span><span class="n">StringPiece</span> <span class="n">input</span><span class="p">,</span>
                  <span class="n">fbstring</span><span class="o">&amp;</span> <span class="n">out</span><span class="p">,</span>
                  <span class="k">const</span> <span class="n">serialization_opts</span><span class="o">&amp;</span> <span class="n">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">hexDigit</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">char</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">?</span> <span class="n">c</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span> <span class="o">:</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">+</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="n">out</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">input</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\&quot;&#39;</span><span class="p">);</span>

  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">input</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">q</span> <span class="o">=</span> <span class="n">input</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">e</span> <span class="o">=</span> <span class="n">input</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Since non-ascii encoding inherently does utf8 validation
we explicitly validate utf8 only if non-ascii encoding is disabled.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="n">validate_utf8</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">opts</span><span class="p">.</span><span class="n">encode_non_ascii</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>to achieve better spatial and temporal coherence
we do utf8 validation progressively along with the
string-escaping instead of two separate passes</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>as the encoding progresses, q will stay at or ahead of p</p></td><td class="code"><div class="highlight"><pre>      <span class="n">CHECK</span><span class="p">(</span><span class="n">q</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>as p catches up with q, move q forward</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>calling utf8_decode has the side effect of
checking that utf8 encodings are valid</p></td><td class="code"><div class="highlight"><pre>        <span class="n">decodeUtf8</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="n">encode_non_ascii</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">char32_t</span> <span class="n">v</span> <span class="o">=</span> <span class="n">decodeUtf8</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
      <span class="n">out</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">u&quot;</span><span class="p">);</span>
      <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">hexDigit</span><span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">));</span>
      <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">hexDigit</span><span class="p">((</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
      <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">hexDigit</span><span class="p">((</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
      <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">hexDigit</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\&quot;&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\\&#39;</span><span class="p">);</span>
      <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">);</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&lt;=</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>note that this if condition captures both control characters
and extended ascii characters</p></td><td class="code"><div class="highlight"><pre>      <span class="n">out</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">u00&quot;</span><span class="p">);</span>
      <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">hexDigit</span><span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
      <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">hexDigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>
      <span class="n">p</span><span class="o">++</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\&quot;&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">Printer</span> <span class="p">{</span>
  <span class="k">explicit</span> <span class="n">Printer</span><span class="p">(</span><span class="n">fbstring</span><span class="o">&amp;</span> <span class="n">out</span><span class="p">,</span>
                   <span class="kt">unsigned</span><span class="o">*</span> <span class="n">indentLevel</span><span class="p">,</span>
                   <span class="n">serialization_opts</span> <span class="k">const</span><span class="o">*</span> <span class="n">opts</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">out_</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">indentLevel_</span><span class="p">(</span><span class="n">indentLevel</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">opts_</span><span class="p">(</span><span class="o">*</span><span class="n">opts</span><span class="p">)</span>
  <span class="p">{}</span>

  <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">dynamic</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">type</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">dynamic</span><span class="o">::</span><span class="nl">DOUBLE:</span>
      <span class="n">toAppend</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">asDouble</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">out_</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">dynamic</span><span class="o">::</span><span class="nl">INT64:</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">intval</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">asInt</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">opts_</span><span class="p">.</span><span class="n">javascript_safe</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Use folly::to to check that this integer can be represented
as a double without loss of precision.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">intval</span> <span class="o">=</span> <span class="n">int64_t</span><span class="p">(</span><span class="n">to</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">intval</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="n">toAppend</span><span class="p">(</span><span class="n">intval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="n">dynamic</span><span class="o">::</span><span class="nl">BOOL:</span>
      <span class="n">out_</span> <span class="o">+=</span> <span class="n">v</span><span class="p">.</span><span class="n">asBool</span><span class="p">()</span> <span class="o">?</span> <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">dynamic</span><span class="o">::</span><span class="nl">NULLT:</span>
      <span class="n">out_</span> <span class="o">+=</span> <span class="s">&quot;null&quot;</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">dynamic</span><span class="o">::</span><span class="nl">STRING:</span>
      <span class="n">escapeString</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">out_</span><span class="p">,</span> <span class="n">opts_</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">dynamic</span><span class="o">::</span><span class="nl">OBJECT:</span>
      <span class="n">printObject</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">dynamic</span><span class="o">::</span><span class="nl">ARRAY:</span>
      <span class="n">printArray</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="n">CHECK</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Bad type &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">.</span><span class="n">type</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">printKV</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">dynamic</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">&gt;&amp;</span> <span class="n">p</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opts_</span><span class="p">.</span><span class="n">allow_non_string_keys</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">p</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">isString</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;folly::toJson: JSON object key was not a &quot;</span>
        <span class="s">&quot;string&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)(</span><span class="n">p</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
    <span class="n">mapColon</span><span class="p">();</span>
    <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)(</span><span class="n">p</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">printObject</span><span class="p">(</span><span class="n">dynamic</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">o</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">out_</span> <span class="o">+=</span> <span class="s">&quot;{}&quot;</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">out_</span> <span class="o">+=</span> <span class="sc">&#39;{&#39;</span><span class="p">;</span>
    <span class="n">indent</span><span class="p">();</span>
    <span class="n">newline</span><span class="p">();</span>
    <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">o</span><span class="p">.</span><span class="n">items</span><span class="p">().</span><span class="n">begin</span><span class="p">();</span>
    <span class="n">printKV</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="o">++</span><span class="n">it</span><span class="p">;</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">o</span><span class="p">.</span><span class="n">items</span><span class="p">().</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">out_</span> <span class="o">+=</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>
      <span class="n">newline</span><span class="p">();</span>
      <span class="n">printKV</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">outdent</span><span class="p">();</span>
    <span class="n">newline</span><span class="p">();</span>
    <span class="n">out_</span> <span class="o">+=</span> <span class="sc">&#39;}&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">printArray</span><span class="p">(</span><span class="n">dynamic</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">out_</span> <span class="o">+=</span> <span class="s">&quot;[]&quot;</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">out_</span> <span class="o">+=</span> <span class="sc">&#39;[&#39;</span><span class="p">;</span>
    <span class="n">indent</span><span class="p">();</span>
    <span class="n">newline</span><span class="p">();</span>
    <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="n">val</span> <span class="o">:</span> <span class="n">makeRange</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">next</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">begin</span><span class="p">()),</span> <span class="n">a</span><span class="p">.</span><span class="n">end</span><span class="p">()))</span> <span class="p">{</span>
      <span class="n">out_</span> <span class="o">+=</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>
      <span class="n">newline</span><span class="p">();</span>
      <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)(</span><span class="n">val</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">outdent</span><span class="p">();</span>
    <span class="n">newline</span><span class="p">();</span>
    <span class="n">out_</span> <span class="o">+=</span> <span class="sc">&#39;]&#39;</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">outdent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">indentLevel_</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">--*</span><span class="n">indentLevel_</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">indent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">indentLevel_</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">++*</span><span class="n">indentLevel_</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">newline</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">indentLevel_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">out_</span> <span class="o">+=</span> <span class="n">to</span><span class="o">&lt;</span><span class="n">fbstring</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">fbstring</span><span class="p">(</span><span class="o">*</span><span class="n">indentLevel_</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">mapColon</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">out_</span> <span class="o">+=</span> <span class="n">indentLevel_</span> <span class="o">?</span> <span class="s">&quot; : &quot;</span> <span class="o">:</span> <span class="s">&quot;:&quot;</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">fbstring</span><span class="o">&amp;</span> <span class="n">out_</span><span class="p">;</span>
  <span class="kt">unsigned</span><span class="o">*</span> <span class="k">const</span> <span class="n">indentLevel_</span><span class="p">;</span>
  <span class="n">serialization_opts</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">opts_</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>////////////////////////////////////////////////////////////////////</p></td><td class="code"><div class="highlight"><pre><span class="k">struct</span> <span class="n">ParseError</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span> <span class="p">{</span>
  <span class="k">explicit</span> <span class="n">ParseError</span><span class="p">(</span><span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="n">to</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;json parse error on line &quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
  <span class="p">{}</span>

  <span class="k">explicit</span> <span class="n">ParseError</span><span class="p">(</span><span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">context</span><span class="p">,</span>
      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">expected</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="n">to</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;json parse error on line &quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
        <span class="o">!</span><span class="n">context</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">?</span> <span class="n">to</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot; near `&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span>
                        <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
        <span class="s">&quot;: &quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">))</span>
  <span class="p">{}</span>

  <span class="k">explicit</span> <span class="n">ParseError</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">what</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;json parse error: &quot;</span> <span class="o">+</span> <span class="n">what</span><span class="p">)</span>
  <span class="p">{}</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Wraps our input buffer with some helper functions.</p></td><td class="code"><div class="highlight"><pre><span class="k">struct</span> <span class="n">Input</span> <span class="p">{</span>
  <span class="k">explicit</span> <span class="n">Input</span><span class="p">(</span><span class="n">StringPiece</span> <span class="n">range</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">range_</span><span class="p">(</span><span class="n">range</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">lineNum_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">storeCurrent</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">Input</span><span class="p">(</span><span class="n">Input</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
  <span class="n">Input</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">Input</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>

  <span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="n">begin</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">range_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Parse ahead for as long as the supplied predicate is satisfied,
returning a range of what was skipped.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Predicate</span><span class="o">&gt;</span>
  <span class="n">StringPiece</span> <span class="n">skipWhile</span><span class="p">(</span><span class="k">const</span> <span class="n">Predicate</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">skipped</span> <span class="o">&lt;</span> <span class="n">range_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">skipped</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">(</span><span class="n">range_</span><span class="p">[</span><span class="n">skipped</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">range_</span><span class="p">[</span><span class="n">skipped</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">++</span><span class="n">lineNum_</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">range_</span><span class="p">.</span><span class="n">subpiece</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">skipped</span><span class="p">);</span>
    <span class="n">range_</span><span class="p">.</span><span class="n">advance</span><span class="p">(</span><span class="n">skipped</span><span class="p">);</span>
    <span class="n">storeCurrent</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">StringPiece</span> <span class="n">skipDigits</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">skipWhile</span><span class="p">([]</span> <span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">;</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">skipWhitespace</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Spaces other than ' ' characters are less common but should be
checked.  This configuration where we loop on the ' '
separately from oddspaces was empirically fastest.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">auto</span> <span class="n">oddspace</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\t&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">;</span>
    <span class="p">};</span>

  <span class="nl">loop:</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="o">!</span><span class="n">range_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">range_</span><span class="p">.</span><span class="n">front</span><span class="p">()</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">;</span> <span class="n">range_</span><span class="p">.</span><span class="n">pop_front</span><span class="p">())</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">oddspace</span><span class="p">(</span><span class="n">range_</span><span class="p">.</span><span class="n">front</span><span class="p">()))</span> <span class="p">{</span>
      <span class="n">range_</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
      <span class="k">goto</span> <span class="n">loop</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">storeCurrent</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">expect</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">**</span><span class="k">this</span> <span class="o">!=</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="n">ParseError</span><span class="p">(</span><span class="n">lineNum_</span><span class="p">,</span> <span class="n">context</span><span class="p">(),</span>
        <span class="n">to</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;expected &#39;&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="sc">&#39;\&#39;&#39;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="o">++*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">range_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">current_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="k">operator</span><span class="o">++</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">range_</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
    <span class="n">storeCurrent</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
  <span class="n">T</span> <span class="n">extract</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">to</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">range_</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">consume</span><span class="p">(</span><span class="n">StringPiece</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">starts_with</span><span class="p">(</span><span class="n">range_</span><span class="p">,</span> <span class="n">str</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">range_</span><span class="p">.</span><span class="n">advance</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
      <span class="n">storeCurrent</span><span class="p">();</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">context</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">range_</span><span class="p">.</span><span class="n">subpiece</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span> <span class="cm">/* arbitrary */</span><span class="p">).</span><span class="n">toString</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">dynamic</span> <span class="n">error</span><span class="p">(</span><span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="n">what</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">ParseError</span><span class="p">(</span><span class="n">lineNum_</span><span class="p">,</span> <span class="n">context</span><span class="p">(),</span> <span class="n">what</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">storeCurrent</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">current_</span> <span class="o">=</span> <span class="n">range_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">?</span> <span class="n">EOF</span> <span class="o">:</span> <span class="n">range_</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">StringPiece</span> <span class="n">range_</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">lineNum_</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">current_</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">dynamic</span> <span class="n">parseValue</span><span class="p">(</span><span class="n">Input</span><span class="o">&amp;</span> <span class="n">in</span><span class="p">);</span>
<span class="n">fbstring</span> <span class="n">parseString</span><span class="p">(</span><span class="n">Input</span><span class="o">&amp;</span> <span class="n">in</span><span class="p">);</span>

<span class="n">dynamic</span> <span class="n">parseObject</span><span class="p">(</span><span class="n">Input</span><span class="o">&amp;</span> <span class="n">in</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;{&#39;</span><span class="p">);</span>
  <span class="o">++</span><span class="n">in</span><span class="p">;</span>

  <span class="n">dynamic</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">dynamic</span><span class="o">::</span><span class="n">object</span><span class="p">;</span>

  <span class="n">in</span><span class="p">.</span><span class="n">skipWhitespace</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;}&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">++</span><span class="n">in</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">!=</span> <span class="sc">&#39;\&quot;&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">in</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;expected string for object key name&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="n">key</span> <span class="o">=</span> <span class="n">parseString</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
    <span class="n">in</span><span class="p">.</span><span class="n">skipWhitespace</span><span class="p">();</span>
    <span class="n">in</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="sc">&#39;:&#39;</span><span class="p">);</span>
    <span class="n">in</span><span class="p">.</span><span class="n">skipWhitespace</span><span class="p">();</span>
    <span class="n">ret</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">parseValue</span><span class="p">(</span><span class="n">in</span><span class="p">));</span>
    <span class="n">in</span><span class="p">.</span><span class="n">skipWhitespace</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">++</span><span class="n">in</span><span class="p">;</span>
    <span class="n">in</span><span class="p">.</span><span class="n">skipWhitespace</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">in</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="sc">&#39;}&#39;</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">dynamic</span> <span class="n">parseArray</span><span class="p">(</span><span class="n">Input</span><span class="o">&amp;</span> <span class="n">in</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">);</span>
  <span class="o">++</span><span class="n">in</span><span class="p">;</span>

  <span class="n">dynamic</span> <span class="n">ret</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="n">in</span><span class="p">.</span><span class="n">skipWhitespace</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">++</span><span class="n">in</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="n">ret</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">parseValue</span><span class="p">(</span><span class="n">in</span><span class="p">));</span>
    <span class="n">in</span><span class="p">.</span><span class="n">skipWhitespace</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">++</span><span class="n">in</span><span class="p">;</span>
    <span class="n">in</span><span class="p">.</span><span class="n">skipWhitespace</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">in</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="sc">&#39;]&#39;</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">dynamic</span> <span class="n">parseNumber</span><span class="p">(</span><span class="n">Input</span><span class="o">&amp;</span> <span class="n">in</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="k">const</span> <span class="n">negative</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">negative</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">++</span><span class="n">in</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">consume</span><span class="p">(</span><span class="s">&quot;Infinity&quot;</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">-</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">infinity</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">auto</span> <span class="n">integral</span> <span class="o">=</span> <span class="n">in</span><span class="p">.</span><span class="n">skipDigits</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">integral</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">in</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;expected digits after `-&#39;&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">wasE</span> <span class="o">=</span> <span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;e&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;E&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">!=</span> <span class="sc">&#39;.&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wasE</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">val</span> <span class="o">=</span> <span class="n">to</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">integral</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">negative</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">val</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">in</span><span class="p">.</span><span class="n">skipWhitespace</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">val</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">auto</span> <span class="n">end</span> <span class="o">=</span> <span class="o">!</span><span class="n">wasE</span> <span class="o">?</span> <span class="p">(</span><span class="o">++</span><span class="n">in</span><span class="p">,</span> <span class="n">in</span><span class="p">.</span><span class="n">skipDigits</span><span class="p">().</span><span class="n">end</span><span class="p">())</span> <span class="o">:</span> <span class="n">in</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;e&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;E&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">++</span><span class="n">in</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">++</span><span class="n">in</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="n">expPart</span> <span class="o">=</span> <span class="n">in</span><span class="p">.</span><span class="n">skipDigits</span><span class="p">();</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">expPart</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">auto</span> <span class="n">fullNum</span> <span class="o">=</span> <span class="n">makeRange</span><span class="p">(</span><span class="n">integral</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">end</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">val</span> <span class="o">=</span> <span class="n">to</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fullNum</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">negative</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">val</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">fbstring</span> <span class="n">decodeUnicodeEscape</span><span class="p">(</span><span class="n">Input</span><span class="o">&amp;</span> <span class="n">in</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">hexVal</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">unsigned</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span> <span class="o">?</span> <span class="n">c</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span> <span class="o">:</span>
           <span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;a&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;f&#39;</span> <span class="o">?</span> <span class="n">c</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">:</span>
           <span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;F&#39;</span> <span class="o">?</span> <span class="n">c</span> <span class="o">-</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">:</span>
           <span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;invalid hex digit&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">auto</span> <span class="n">readHex</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">in</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;expected 4 hex digits&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">uint16_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">hexVal</span><span class="p">(</span><span class="o">*</span><span class="n">in</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">;</span>
    <span class="o">++</span><span class="n">in</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">hexVal</span><span class="p">(</span><span class="o">*</span><span class="n">in</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span><span class="p">;</span>
    <span class="o">++</span><span class="n">in</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">hexVal</span><span class="p">(</span><span class="o">*</span><span class="n">in</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
    <span class="o">++</span><span class="n">in</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">hexVal</span><span class="p">(</span><span class="o">*</span><span class="n">in</span><span class="p">);</span>
    <span class="o">++</span><span class="n">in</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="cm">/*</span>
<span class="cm">   * If the value encoded is in the surrogate pair range, we need to</span>
<span class="cm">   * make sure there is another escape that we can use also.</span>
<span class="cm">   */</span>
  <span class="n">uint32_t</span> <span class="n">codePoint</span> <span class="o">=</span> <span class="n">readHex</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">codePoint</span> <span class="o">&gt;=</span> <span class="mh">0xd800</span> <span class="o">&amp;&amp;</span> <span class="n">codePoint</span> <span class="o">&lt;=</span> <span class="mh">0xdbff</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in</span><span class="p">.</span><span class="n">consume</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">u&quot;</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">in</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;expected another unicode escape for second half of &quot;</span>
        <span class="s">&quot;surrogate pair&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">uint16_t</span> <span class="n">second</span> <span class="o">=</span> <span class="n">readHex</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">second</span> <span class="o">&gt;=</span> <span class="mh">0xdc00</span> <span class="o">&amp;&amp;</span> <span class="n">second</span> <span class="o">&lt;=</span> <span class="mh">0xdfff</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">codePoint</span> <span class="o">=</span> <span class="mh">0x10000</span> <span class="o">+</span> <span class="p">((</span><span class="n">codePoint</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span>
                  <span class="p">(</span><span class="n">second</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">in</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;second character in surrogate pair is invalid&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">codePoint</span> <span class="o">&gt;=</span> <span class="mh">0xdc00</span> <span class="o">&amp;&amp;</span> <span class="n">codePoint</span> <span class="o">&lt;=</span> <span class="mh">0xdfff</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">in</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;invalid unicode code point (in range [0xdc00,0xdfff])&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">codePointToUtf8</span><span class="p">(</span><span class="n">codePoint</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">fbstring</span> <span class="n">parseString</span><span class="p">(</span><span class="n">Input</span><span class="o">&amp;</span> <span class="n">in</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;\&quot;&#39;</span><span class="p">);</span>
  <span class="o">++</span><span class="n">in</span><span class="p">;</span>

  <span class="n">fbstring</span> <span class="n">ret</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">range</span> <span class="o">=</span> <span class="n">in</span><span class="p">.</span><span class="n">skipWhile</span><span class="p">(</span>
      <span class="p">[]</span> <span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\&quot;&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">);</span>
    <span class="n">ret</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">range</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;\&quot;&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">++</span><span class="n">in</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">++</span><span class="n">in</span><span class="p">;</span>
      <span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="sc">&#39;\&quot;&#39;</span><span class="o">:</span>    <span class="n">ret</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\&quot;&#39;</span><span class="p">);</span> <span class="o">++</span><span class="n">in</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">&#39;\\&#39;</span><span class="o">:</span>    <span class="n">ret</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\\&#39;</span><span class="p">);</span> <span class="o">++</span><span class="n">in</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">&#39;/&#39;</span><span class="o">:</span>     <span class="n">ret</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">);</span>  <span class="o">++</span><span class="n">in</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">&#39;b&#39;</span><span class="o">:</span>     <span class="n">ret</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\b&#39;</span><span class="p">);</span> <span class="o">++</span><span class="n">in</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">&#39;f&#39;</span><span class="o">:</span>     <span class="n">ret</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\f&#39;</span><span class="p">);</span> <span class="o">++</span><span class="n">in</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="o">:</span>     <span class="n">ret</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span> <span class="o">++</span><span class="n">in</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">&#39;r&#39;</span><span class="o">:</span>     <span class="n">ret</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\r&#39;</span><span class="p">);</span> <span class="o">++</span><span class="n">in</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="o">:</span>     <span class="n">ret</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\t&#39;</span><span class="p">);</span> <span class="o">++</span><span class="n">in</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">&#39;u&#39;</span><span class="o">:</span>     <span class="o">++</span><span class="n">in</span><span class="p">;</span> <span class="n">ret</span> <span class="o">+=</span> <span class="n">decodeUnicodeEscape</span><span class="p">(</span><span class="n">in</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>      <span class="n">in</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">to</span><span class="o">&lt;</span><span class="n">fbstring</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;unknown escape &quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span>
                                          <span class="s">&quot; in string&quot;</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
      <span class="p">}</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">in</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;unterminated string&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * Apparently we&#39;re actually supposed to ban all control</span>
<span class="cm">       * characters from strings.  This seems unnecessarily</span>
<span class="cm">       * restrictive, so we&#39;re only banning zero bytes.  (Since the</span>
<span class="cm">       * string is presumed to be UTF-8 encoded it&#39;s fine to just</span>
<span class="cm">       * check this way.)</span>
<span class="cm">       */</span>
      <span class="n">in</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;null byte in string&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">ret</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">in</span><span class="p">);</span>
    <span class="o">++</span><span class="n">in</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">dynamic</span> <span class="n">parseValue</span><span class="p">(</span><span class="n">Input</span><span class="o">&amp;</span> <span class="n">in</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">in</span><span class="p">.</span><span class="n">skipWhitespace</span><span class="p">();</span>
  <span class="k">return</span> <span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span> <span class="o">?</span> <span class="n">parseArray</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="o">:</span>
         <span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;{&#39;</span> <span class="o">?</span> <span class="n">parseObject</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="o">:</span>
         <span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;\&quot;&#39;</span> <span class="o">?</span> <span class="n">parseString</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="o">:</span>
         <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">in</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">))</span> <span class="o">?</span> <span class="n">parseNumber</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="o">:</span>
         <span class="n">in</span><span class="p">.</span><span class="n">consume</span><span class="p">(</span><span class="s">&quot;true&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span>
         <span class="n">in</span><span class="p">.</span><span class="n">consume</span><span class="p">(</span><span class="s">&quot;false&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span>
         <span class="n">in</span><span class="p">.</span><span class="n">consume</span><span class="p">(</span><span class="s">&quot;null&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="n">nullptr</span> <span class="o">:</span>
         <span class="n">in</span><span class="p">.</span><span class="n">consume</span><span class="p">(</span><span class="s">&quot;Infinity&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">infinity</span><span class="p">()</span> <span class="o">:</span>
         <span class="n">in</span><span class="p">.</span><span class="n">consume</span><span class="p">(</span><span class="s">&quot;NaN&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">quiet_NaN</span><span class="p">()</span> <span class="o">:</span>
         <span class="n">in</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;expected json value&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">}</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>////////////////////////////////////////////////////////////////////</p></td><td class="code"><div class="highlight"><pre><span class="n">fbstring</span> <span class="n">serialize</span><span class="p">(</span><span class="n">dynamic</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">dyn</span><span class="p">,</span> <span class="n">serialization_opts</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">fbstring</span> <span class="n">ret</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">indentLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">Printer</span> <span class="n">p</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">opts</span><span class="p">.</span><span class="n">pretty_formatting</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">indentLevel</span> <span class="o">:</span> <span class="n">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>
  <span class="n">p</span><span class="p">(</span><span class="n">dyn</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>////////////////////////////////////////////////////////////////////</p></td><td class="code"><div class="highlight"><pre><span class="n">dynamic</span> <span class="n">parseJson</span><span class="p">(</span><span class="n">StringPiece</span> <span class="n">range</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">json</span><span class="o">::</span><span class="n">Input</span> <span class="n">in</span><span class="p">(</span><span class="n">range</span><span class="p">);</span>

  <span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">parseValue</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
  <span class="n">in</span><span class="p">.</span><span class="n">skipWhitespace</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">in</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">in</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;parsing didn&#39;t consume all input&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">fbstring</span> <span class="n">toJson</span><span class="p">(</span><span class="n">dynamic</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">dyn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">json</span><span class="o">::</span><span class="n">serialize</span><span class="p">(</span><span class="n">dyn</span><span class="p">,</span> <span class="n">json</span><span class="o">::</span><span class="n">serialization_opts</span><span class="p">());</span>
<span class="p">}</span>

<span class="n">fbstring</span> <span class="n">toPrettyJson</span><span class="p">(</span><span class="n">dynamic</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">dyn</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">json</span><span class="o">::</span><span class="n">serialization_opts</span> <span class="n">opts</span><span class="p">;</span>
  <span class="n">opts</span><span class="p">.</span><span class="n">pretty_formatting</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">json</span><span class="o">::</span><span class="n">serialize</span><span class="p">(</span><span class="n">dyn</span><span class="p">,</span> <span class="n">opts</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>////////////////////////////////////////////////////////////////////
dynamic::print<em>as</em>pseudo_json() is implemented here for header
ordering reasons (most of the dynamic implementation is in
dynamic-inl.h, which we don't want to include json.h).</p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="n">dynamic</span><span class="o">::</span><span class="n">print_as_pseudo_json</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">out</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">json</span><span class="o">::</span><span class="n">serialization_opts</span> <span class="n">opts</span><span class="p">;</span>
  <span class="n">opts</span><span class="p">.</span><span class="n">allow_non_string_keys</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">json</span><span class="o">::</span><span class="n">serialize</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">opts</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>////////////////////////////////////////////////////////////////////</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/folly",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
